Scanning and mapping the network to which the exploited machine is connected to, is a very important phase of a penetration test.

From the exploited machine the attacker can find other devices, like computers or servers, and exploit them in order to 
gain additional information to which few people should have access to.

Since the attacker cannot directly reach the remote network, he does tunnel his traffic into the (reverse).
In order to do so there are two ways:
- route add x.x.x.x (dest-network) xx.xx.xx.xx (netmask) X (meterpreter session to act as gateway)
- run autoroute -s x.x.x.x/x (dest-network)
The exploited machine becomes a router able to route attacker's incoming traffic to the specified remote destination.

All traffic sent from the attacker through the exploited machine will have, as Source IP Address, the IP Address of the
very exploited machine. No IPs from the attacker is used.

This technique is called Pivoting.

In order to tunnel traffic from tools and scripts other than Metasploit and Meterpreter's built-in, the penetration tester
needs to configure a proxy server to forward traffic to the correct destination.
socks4a is a Metasploit module useful to create a proxy server able to use Metasploit built-in routing to relay connections.
Once the socks4a proxy server is ready, another tool like proxychain will take care of actually forwarding all TCP traffic
the a specific proxy server.

TOOLS -> PROXYCHAINS -> METASPLOIT SOCKS4A PROXY -> METERPRETER ROUTES -> METERPRETER SESSION -> TARGET NETWORK

For example, to use NMAP:
- proxychains nmap x.x.x.x (prepending proxychains to a command it will be forced to send its traffic through the proxy)


Usefule commands are:
- ipconfig/ifconfig: (Windows/Linux-Meterpreter)
- route print/route -v: (Windows/Linux)
- arp
- netstat
- run arp_scanner: (Meterpreter) ARP scan that returns IP:MAC pairs found
- use post/multi/gather/ping_sweep: (Meterpreter) PING scan
- run netenum: (Meterpreter) Enumeration from meterpreter shell
- use auxiliary/server/socks4a
- proxychains
- portfwd: (Meterpreter) Create proxy server for traffic "tunneling" to another host


In Windows environment a very good flaw to exploit lies in how Windows treats logon credentials on network shares.
In fact, Windows not only accepts clear-text password but also their hashes.
Therefore, it may well happen that a specific user (like Administrator) is found on different machines but having always
the very same password.
Dumping the hashes (NT or LM) on one machine, may allow the attacker to perform a pass-the-hash attack resulting in a 
reverse shell.

Metasploit "run exploit/windows/smb/psexec" module does just that, exploit this "pass-the-hash" vulnerability in Windows
(caused by missing salts in Windows hashes) and execute the specified payload, a reverse shell for example.


