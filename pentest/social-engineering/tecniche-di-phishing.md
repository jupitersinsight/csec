## 1. Sfruttare CSRF (Cross-Site Request Forgery) e gli Open Redirects
Una vulnerabilità CSRF si ha quando un hacker riesce a manipolare le azioni in una applicazioni web sfruttando la sessione in uso dalla vittima.  
Un esempio di qualche anno fa con CSRF sul sito di LastPass: https://www.seancassidy.me/lostpass.html

Esempio di sfruttamento degli Open redirects:
- Individuare un sito web popolare che abbia questa funzionalità/vulnerabilità (ad esempio Google)
- Creare sul proprio dominio una cartella nominana _\_ah_ al suo interno la cartella _conflogin_
- Inserire in quest'ultima cartella la pagina di phishing in formato .html o .php (index.html o index.php)  
- Inviare il link di seguito alla vittima: https://accounts.google.com/ServiceLogin?continue=https%3A%2F%2Fappengine.google.com%2F_ah%2Fconflogin%3Fcontinue%3Dhttps%3A%2F%2Fattacker.domain%2F&service=ah

Quando la vittima apre il link compare la pagina di autenticazione ai servizi Google.  
Una volta inserite, la vittima è reindirizzata alla pagina di phishing da cui è possibile eseguire diversi attacchi come usare un file .hta per prelevare delle credenziali o agganciare il browser della vittima a una istanza di BeEF.  

## 2. Creare Form verosimili con reindirizzamenti nascosti
Siccome le campgne di phishing hanno attirato su di sè parecchia attenzione nel corso degli anni, molti utenti sanno riconoscere se un link piuttosto che un file sono malevoli oppure no.  
Una semplice verifica consiste nel posizionare il mouse sopra al collegamento, senza cliccarlo, e verificare nell'anteprima il contenuto.  
Se il link punta verso una risorsa affidabile e corretta allora si può procedere.  

O forse no...  

Usando uno script che funge da Man-in-the-Middle, alla vittima viene mostrato che il link punta a una risorsa affidabile ma in realtà lo script comunica anche con un dominio sotto controllo dell'hacker.  

Elenco di link a componenti per finto form PayPal:
- capture_and_redirect.js: https://gist.github.com/anonymous/3bf8342c76eba4da3f660cbffa24f5d8
- form PayPal HTML: https://gist.github.com/anonymous/75b5eb6578bbc5bfcabe44e8fbb952ea
- jquery.ba-hashchange.min.js: https://gist.github.com/anonymous/950a70cdebd3e78b6e88312fa7d93250

## 3. URL Spoofing
Una tecnica comune di URL spoofing consiste nello sfruutare lo scheda dei dati URI (Data URI Scheme).  
Questo schema consente di visualizzare il contenuto dei file media nel browser web senza che i file da riprodurre siano caricati in Internet.  
Un esempio dello schema: _data:[\<mediatype\>]\[;base64],\<data>_  
Per \<mediatype> si intende uno dei tipi MIME descritti nella RFC 2046.  
I tipi MIME erano inizialmente pensati per l'uso con i sistemi di posta elettronica ma sono ormai uno standard per l'identificazione dei tipi di file presente in Internet.  

Per iniziare l'operazione di spoof di una URL bisogna creare una _landing page_ simile a quella al link: https://gist.github.com/anonymous/907cc8e9dcc43c6a4412e682e5d5c2cd
Lo spazio aggiuntivo tra le linee consente di "nascondere" la sezione dedicata all'iframe.  
È anche possibile includere la versione condificata in base64 dell'indirizzo: _data:text/html;base64,\[sorgente HTML codificata in base64]_  

Per "nascondere" il codice sorgente relativo alla sezione di phishing si possono applicare diversi strati di codifica/crittografia.  
Esempio con tre livelli:
- Primo livello: https://www.webtoolhub.com/tn561359-html-encrypter.aspx
- Secondo livello: https://javascriptobfuscator.com/
- Terzo livello: https://gist.github.com/ianpurton/1122562

Per crittografare il risultato del **secondo** passaggio usare lo script (che legge dal link del terzo link qui sopra): https://gist.github.com/anonymous/315be2adc72603005d7c7b176c163ed7
Infine usare lo script di decrittografia (https://gist.github.com/anonymous/e749f1b8fcbdb08b9d709eb1df8b9575) e inserire il risultato di sopra nel campo della variabile _to\_aes\_decrypt_.  
Il risultato è il codice da usare per l'attacco di phishing.  

Altre tecniche di URL Obfuscation:
- https://web.archive.org/web/20140702141151/http:/morph3us.org/blog/index.php?/archives/35-Dotless-IP-addresses-and-URL-Obfuscation.html
- https://web.archive.org/web/20140701103027/http://www.pc-help.org/obscure.htm
- http://www.irongeek.com/i.php?page=security/out-of-character-use-of-punycode-and-homoglyph-attacks-to-obfuscate-urls-for-phishing
- https://www.brokenbrowser.com/bypass-the-patch-to-keep-spoofing-the-address-bar-with-the-malware-warning/
- https://www.vgrsec.com/post20170219.html
- https://www.xudongz.com/blog/2017/idn-phishing/

## 4. BeEF
Acronimo di Browser Exploitation Framework.  

Esempi di utilizzo di seguito in scenario consfruttamento iniziale di XSS e CSRF in un plugindi WordPress.  
Download plugin: [contact-form-manager-1.4.1.zip](https://github.com/jupitersinsight/pentest/files/9725283/contact-form-manager-1.4.1.zip)


![image](https://user-images.githubusercontent.com/110602224/194284546-716b6394-0520-41a7-87ab-d57dc1679adc.png)
![image](https://user-images.githubusercontent.com/110602224/194286205-ccd93602-9db7-4def-ba44-98d1c4880b04.png)
![image](https://user-images.githubusercontent.com/110602224/194286253-abcd11db-b44a-42aa-adde-cc43ecfd0ad0.png)

**PoC**: https://sumofpwn.nl/advisory/2016/cross_site_request_forgery___cross_site_scripting_in_contact_form_manager_wordpress_plugin.html


#### 1. XSS + SAMEORIGIN + Autocomplete = Credenziali amministratore
Concatenamento vulnerabilità XSS e CSRF, X-Frame Options non sicuro, attivazione della funzionalità Autocomplete.  

L'header della pagina di login non impedisce la creazione e apertura di contenitori iframe (X-Frame Options : SAMEORIGIN).  
Sfruttando la vulnerabilità XSS si crea un iframe invisibile che contiene la pagina di login all'area riservata di WordPress (quindi tutto all'interno della pagina vulnerabile a XSS).  
Se la pagina di login ha la funzionalità di Autocompletamento attiva, attraverso altro codice Javascript è possibile estrarre le credenziali dell'utente amministratore.  

1. Creazione dell'iframe invisibile
![image](https://user-images.githubusercontent.com/110602224/194330561-c0c0bdc2-a199-41dd-a856-adaff2a6b8d2.png)

2. Una volta che viene caricato l'iframe all'interno della pagina vulnerabile a XSS, si inietta del codice Javascript per rubare le credenziali amministrative (se la pagina di login ha la funzionalità di Autocompletamento attiva) usando la funzione di BeEF "inject raw Javascript".  
Link allo script: https://gist.github.com/anonymous/1b369a11090f1991d88356578fc58b61

![image](https://user-images.githubusercontent.com/110602224/194332003-998f6f5f-fa46-4b1c-b8e9-23a6a4196865.png)

#### 2. XSS + CSRF bypass + Admin level access
Concatenamento vulnerabilità XSS e CSRF per aggirare la protezione contro CSRF in uso in WordPress e inserimento di codice Javascript personalizzato per ottenimento accesso amministrativo.  

Sfruttando la vulnerabilità XSS è possibile aggirare la protezione anti-CSRF, catturando il nonce e poi inviando una richiesta propriamente formata per aggiungere un nuovo account amministratore.  

La stessa funzionalità di BEeF del punto 1 permette di inserire il codice al link che segue: https://gist.github.com/anonymous/ba135bd318b49224707f1fcad5826714  

![image](https://user-images.githubusercontent.com/110602224/194340422-03398310-f9e0-4818-b08d-91be8e762320.png)

## 5. Imitare malware di successo come il trojan DYRE
Link a una breve panoramica del trojan: https://threats.kaspersky.com/en/threat/Trojan-Banker.Win32.Dyre/

Questa tecnica può risultare particolarmente utile durante un penetration test interno e si basa su un uso non standard del MAPI (Messaging Application Programming Interface) sui sistemi Windows e sull'imitazione della tecnica di diffusione del trojan DYRE.  

Molto utile sarà Powershell in quanto può accedere facilmente al MAPI attraverso un ComObject di Outlook.  
Link alle specifiche della tecnica descritta: http://www.xorrior.com/phishing-on-the-inside/
