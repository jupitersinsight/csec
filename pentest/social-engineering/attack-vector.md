Raccolta di informazioni ed esempi per lo sviluppo di soluzioni di attacco ad-hoc.
Anche se lo scopo di un hacker è di riuscire nell'intento di compromettere un host o una intera rete lasciano dietro di sè il numero minore di tracce possibile, alcune delle tecniche se seguono lasciano file sul disco.  
Nulla vieta che la stessa tecnica possa essere ottimizzata in modo tale da essere eseguita senza che lasci tracce sul disco e senza che venga rilevata da Antivirus e software di protezione vari.  

### 1. Utilizzo di Macro che sfruttano le proprietà del file per nascondere il payload e sfrutta StdIn per evitare il log delle informazioni
La prima tecnica prevede di nascondere il payload scritto in Powershell nel campo "Autore" dele proprietà del file.  
Al tempo stesso sfrutta l'invocazione con **StdIn.WriteLine** per nascondere i parametri del comando Powershell dal log della linea di comando.  

Powershell è avviato usando una combinazione di argomenti in modo da risultare il più nascosto possibile, ad esempio: "-ExecutionPolicy bypass", "no window", "no loading local profiles".  
L'argomento "AutoOpen" può essere individuato da alcuni Antivirus e quindi bloccato. Un possibile bypass consiste nell'attivazione della Macro tramite un pulsante.  

Ogni volta che si modifica la Macro o il contenuto del file, il campo Autore viene cancellato e riscritto eliminando il comando PowerShell che era stato inserito.  

Il contenuto della Macro si può nascondere in file di Excel, in form o nei fogli di calcolo in forma codificata (encoded).  
È possibile che il componente software Antimalware Scan Interface di Microsoft, parte integrante di Windows 10, individui i comandi Powershell inseriti nella Macro come comportamento malevolo e ne blocchi quindi l'esecuzione.  

La variabile **c** non è usata nella Macro. L'inclusione del file di codice inutilizzato è una tecnica di occultamento (obfuscation) semplice.  

Link a script Macro di esempio: https://gist.github.com/anonymous/70939438968194d2b0f4d5d2cc53c45e  

![image](https://user-images.githubusercontent.com/110602224/192136353-14270874-b33e-4159-96b8-b6fa152a9883.png)

----

### 2. Esecuzione di Macro attraverso ActiveX
Questo malware basato sulle Macro sfrutta una subroutine facente parte dei controlli ActiveX chiamata InkEdit la quale esegue direttamente il codice.  
Per incorporare un controllo ActiveX in un documento:
- Attivare il pannello _sviluppatore_ (File - Options - Customize - Ribbon)
- Dal pannello sviluppatore, alla sezione dedicata ai controlli ne è presente una lista (Strumenti legacy - Altre opzioni)  

Link a script di esempio: https://gist.github.com/anonymous/3e669b249cc1a9343944a282cf30f0b8  
Altro link a script di esempio: https://gist.github.com/anonymous/0e1abbf9364380294b5d9004e1d68213
Link a lista di componenti di ActiveX in rado di eseguire direttamente del codice: http://www.greyhathacker.net/?p=948

![image](https://user-images.githubusercontent.com/110602224/192143683-1f2dd35c-dc2f-425a-a3bb-31ed7ee2cf15.png)
![image](https://user-images.githubusercontent.com/110602224/192143702-81bd466e-1c75-4a3f-b4e3-c71e98821659.png)
![image](https://user-images.githubusercontent.com/110602224/192143725-b35df977-52c1-4f48-a8fc-49c911725b69.png)

----

### 3. Metodo download/esecuzione con una novità
Questa tecnica prevede l'utilizzo di **certutil** per decrittografare un file scaricato e codificato base64 per poi eseguirlo.  
File con estensione .exe sono facilmente individuabili dai software di protezione mentre i file **HTA** portano con sè buone possibilità di eludere i controlli.  
In virtù di quanto appena sopra, programmi come Metasploit, SET, Powershell Empire, Unicorn e altri offrono la possiblità di generare i malware con estensione .hta.   

Link a script di esempio: https://gist.github.com/anonymous/3e7efa917632078693f9c8fdbb7cc756  

![image](https://user-images.githubusercontent.com/110602224/192144130-049e2496-56ec-4ffa-8850-41019a1fdff5.png)

----

### 4. Malware Macro che recupera l'OS in uso ed eseguire il payload corretto.
Tecnica evoluta in cui si fa uso di un malware in grado di determinare il Sistema Operativo in uso ed esegue il payload appopriato.  

Link con script di esempio: https://gist.github.com/anonymous/db37338ba9c59336a0ee3d324d152bc9  
Il payload dell'esempio raccoglie anche informazioni come il nome utente e l'hostname del computer, gli codifica in base64 e li invia al server dell'hacker.  

Per creare un malware che funzioni in OSX è possibile usare il programma **ProjectEmpyre**.  
Dal 2016, sia OSX sia Office 2016,  possono attivare sistemi di sandboxing che possono interferire con l'esecuzione del codice.  
In Windows ci si basa principalmente su Powershell mentre in OSX su Python.  

----

### 5. RTF + Signed Binary, DLL hijacking and custom MSF loader.
Questa tecnica sfrutta il comportamento predefinito dei file con estensione RTF che lasciano nella cartella TEMP una copia degli oggetti OLE incorporati nel file, lasciando invece un file DLL malevolo e un loader di Metasploit/Meterpreter.

Gli oggetti OLE (https://learn.microsoft.com/en-us/cpp/mfc/ole-background?view=msvc-170) permettono all'utente di scambiare tra le applicazioni di Office dati come tabelle, diagrammi, contenuti da copiare/incollare... 

Come procedere.
Modificare il loader di Metasploit che si trova al link https://learn.microsoft.com/en-us/cpp/mfc/ole-background?view=msvc-170 in modo che possa sfruttare la vulnerabilità dell'eseguibile kavremoer.exe (un vecchio file eseguibile di Kaspersky noto per essere vulnerabile a DLL hijacking).  
Modifiche da apportare: Parte1 (https://astr0baby.wordpress.com/2014/02/12/custom-meterpreter-loader-dll/), Parte2 (https://astr0baby.wordpress.com/2014/02/13/customising-meterpreter-loader-dll-part-2/)  

![image](https://user-images.githubusercontent.com/110602224/192149288-df0319bf-1b04-4d7d-8bda-76b904a89b70.png)

![image](https://user-images.githubusercontent.com/110602224/192149462-bad11161-7b27-448d-beb1-547378a40045.png)

----

### 6. Incorporare un eseguibile in una Macro (executable2vbs)
Questa tecnica consiste nell'incorporare un eseguibile all'interno di una Macro sottoforma di stringhe hexdump.  
All'esecuzione della Macro, l'eseguibile è "riassemblato", copiato in una cartella temporanea e da lì eseguito.  
Se i file eseguibili sono bloccati da software di protezione è possibile usare le DLL.

Per incorporare il file in una Macro esistono diversi mezzi tra cui lo script in python _file2vbs_ (scaricato da INE).
Siccome anche questa tecnica lascia molte "impronte" sul disco, è importante adottare sistemi per evadere le protezioni come l'uso di loader personalizzati (come al punto 5) o del "Powershell based beaconing malware" spiegato successivamente.  

![image](https://user-images.githubusercontent.com/110602224/192149842-852cf05e-b621-4430-9099-24c8f79318c1.png)

----

### 7. Macro che monitora la rete e racoglie informazioni
Sfruttando le proprietà offerte da Powershell nel catturare il traffico della rete (https://devblogs.microsoft.com/scripting/packet-sniffing-with-powershell-getting-started/), questa tecnica esegue tramite Macro uno script "packet-sniffer" (https://gist.github.com/anonymous/a3ebd8928135ae29fc341c6036bc7eac)

----

### 8. Multi-Staged Macro malware che sfrutta DNS per recuperare il payload ed esfiltrare i dati (Tecnica Advanced Persistence Threat)  
In questa tecnica la Macro del malware incorpora diversi script, scarica alcuni file sul disco, esegue alcune operazioni di enumerazione e usa DNS sia per scaricare il payload sia per esfiltrare i dati.  

Link di esempio: https://gist.github.com/anonymous/d0da355e5c21a122866808d37234cd5d
![img3](https://user-images.githubusercontent.com/110602224/192623655-03a4f413-b241-4af9-93f3-6ec6b28505f5.png)


La seguente porzione di codice mostra alla vittima dati nei fogli di calcolo per evitare sospetti.  
![image](https://user-images.githubusercontent.com/110602224/192623941-4493d58b-d6f7-4d46-8717-c9e37d10215a.png)

![image](https://user-images.githubusercontent.com/110602224/192624033-b22cf088-5402-4736-9efb-4bd60a9123f8.png)

Durante l'attacco il malware scarica una versione di Mimikatz a un file batch (codice di seguito) al fine di ottenere informazioni critiche come hostname, account utenti e gruppi, amministratori locali e di dominio...  
![image](https://user-images.githubusercontent.com/110602224/192624643-4133e3dc-d92d-449c-8b05-c8ca4153d161.png)

![image](https://user-images.githubusercontent.com/110602224/192624745-ff294737-430f-4620-b053-f26a6fd3b6ac.png)

Estrattp della query DNS usata dal malware:  
![image](https://user-images.githubusercontent.com/110602224/192624901-98f8b8d0-1762-4fb7-960c-cd50699282a5.png)

Link con esempi di uso di DNS via Powershell:
- http://www.labofapenetrationtester.com/2015/01/fun-with-dns-txt-records-and-powershell.html
- http://0entropy.blogspot.gr/2012/04/powershell-metasploit-meterpreter-and.html

----

### 9. Malware Macro che esegue "direct shellcode injection"  
Tecnica molto efficace in termini di attacco in quanto VBA può interagire direttamente con le API di Windows ma al contempo difficile da usare e da celare.  
L'esecuzione di codice di questo tipo è facilmente individuabile da software di protezione. 
Esistono comunque alcune tecniche come quella al link: https://labs.mwrinfosecurity.com/assets/BlogFiles/one-template-to-rule-them-all-t2.pdf

----

### 10. Macro in Powerpoint
La funzionalità da sfruttare in Powerpoint per eseguire le Macro si chiama "Custom Actions".  
Per sfruttare questa tecnica bisogna attivare il tab da sviluppatore (File - Opzioni - Personalizza "Ribbon") -> Sviluppatore -> Visual Basic -> Inserisci -> Modulo.  
Per create il "trigger": Inserisci -> Azione -> scegliere poi Click del mouse o Mouse sopra (over) -> Esegui Macro.  

Per eseguire automaticamente il codice Visual Basic senza sfruttare le "Custom Actions" si può fare usando "Office 2007 CustomUI".
1) Inserire il modulo da usare e salvare il file Powerpoint come file di Powerpoint in grado di eseguire Macro
2) Estrarre il file appena salvato
3) Modificare il file \_rels/.rels e aggiungere il codice che segue prima dell'ultimo </Relationship>.  
**<Relationship  
Type://schemas.microsoft.com/office/2006/relationships/ui/extensibility  
Target="/customUI/customUI.xml"  
Id="Rd6e72c29d34a427e" />**  

4) Creazione una nuova cartella, "customUI", allo stesso livello di \_rels
5) All'interno della cartella creare il file customUI.xml con all'interno il codice:
**<customUI
xmlns=http://schemas.microsoft.com/office/2006/01/customui onLoad="nome del modulo VBA"></customUI>**

6) Creare un archivio dell'intera cartella e rinominarla col nome originale assegnato al file della presentazione Powerpoint

----
----

### 1. Object Linking and Embedding (OLE) Objects
In ambienti dove utilizzo ed esecuzione di Macro sono disattivate, una tecnica prevede lo sfruttamento degli OLE di Microsoft Office per indurre gli utenti finali ad attivare e scaricare del codice malevolo.  
**Object Linking Embeggind** = OLE.

La tecnologia OLE è, appunto, una tecnologia di prorietà di Microsoft che permette la condivisione, incorporazione e collegamento di oggetti e/o documenti in altri documenti.  
In termini di Microsoft, permette ad una applicazione di memorizzare dati di un'altra applicazione.  
L'applicazione che crea i dati è definita come "applicazione creatrice" mentre la seconda come "applicazione contenitrice".  
I dati trasferiti sono riferiti come "oggetto incorporato", embedded object.  

Ad esempio, in Word è possibile inserire un foglio di calcolo di Excel e grazie alla tecnologia OLE, poterlo vidualizzare ed interagirci.  
In sostanza Word riconosce che si tratta di un foglio di calcolo e sfrutta le proprietà di Excel per rendere il foglio visibile, integro e per interagirci.  

Molte sono le estensioni sfruttabili con questa tecnica, come: file VBS, JS, EXE, HTA, CHM, documenti di Office e altri ancora...  

![image](https://user-images.githubusercontent.com/110602224/193595342-cc0dcc76-63cf-4cd2-98b6-016d18ea711b.png)

![image](https://user-images.githubusercontent.com/110602224/193595395-05ac1534-4938-40c4-93be-cf52ce820b89.png)

![image](https://user-images.githubusercontent.com/110602224/193595466-239672c9-2977-46db-ab67-ac579dc1b4fa.png)

![image](https://user-images.githubusercontent.com/110602224/193595654-bdf9a580-07d6-4bae-9595-8ff20cff34b6.png)

----

### 2. Exploit della vulnerabilità MS16-032 tramite DDE di Excel senza macro
DDE (Dynamic Data Exchange) è una vecchia tecnologia di Microsoft usata per facilitare lo scambio di informazioni tra applicazioni, una sorta di IPC (Inter-Communication Process).  
DDE sfrutta spazi di memoria condivisi tra le applicazioni per l'invio di messaggi per lo scambio dei dati.  

Ad esempio, è possibile inserire in una cella di Excel il comando _=cmd/'c calc.exe'!A1_.  
Alcune restrizioni riguardano l'uso di apici singoli e di stringhe brevi. Per usare Powershell è necessario invocarlo tramite cmd con argomenti a seguire.  
![image](https://user-images.githubusercontent.com/110602224/193597664-722f987e-9508-44d2-8857-aa67716f2e9b.png)

![image](https://user-images.githubusercontent.com/110602224/193597709-fc91ed35-1172-40a3-b50a-06d6fda35538.png)

È possibile anche puntare a risorse di rete con file .BAT per dare meno nell'occhio anche se Excel riconosce che l'utilizzo di DDE può risultare in danni al sistema e per questo avvisa l'utente con alcuni messaggi di alert.  
![image](https://user-images.githubusercontent.com/110602224/193598059-b0311bce-3a51-49fb-948c-dd42d5537878.png)

![image](https://user-images.githubusercontent.com/110602224/193598128-ab747e64-29dc-410b-8c8a-0de213eff22c.png)

Con questa tecnica si ottenere una reverse shell con privilegi SYSTEM sfruttando la vulnerabilità MS16-032 (https://web.archive.org/web/20161110175230/https:/technet.microsoft.com/en-us/library/security/ms16-032.aspx).  
Link di approfondimento: https://googleprojectzero.blogspot.com/2016/03/exploiting-leaked-thread-handle.html  
Link a uno script ps1 di esempio: https://gist.github.com/ssherei/41eab0f2c038ce8b355acf80e9ebb980  

----

### 3. Collegamenti gestiti in Office  
Le applicazioni di Windows, tra cui Office, possono essere chiamate inserendo speciali tag nei link. In quello nell'immagine sotto, ad esempio, viene aperto Microsoft Word.  
![image](https://user-images.githubusercontent.com/110602224/193604965-4e6faafe-f1f0-4ea6-833f-a15740ec3590.png)

Vediamo come sfruttare questa funzionalità offerta da Windows

#### CHM - Microsoft Compiled HTML Help
I file .chm sono un insieme di pagine HTML navigabili tramite indice.  
Si tratta di file compressi e installati in formato binario e quando un utente li riceve come allegato di posta elettronica in un attacco phising, deve "sbloccarlo" nella tabella delle proprietà affinché sia utilizzabile e utile all'hacker ma esite un workaround.  

Prima di tutto bisogna armare il file CHM con uno script Javascript che apre una backdoor sfruttando una funzionalità/sotto-tecnica utilizzata nel malware Win32/Poweliks.  
Link con la descrizione del malware e della tecnica in questione: https://www.stormshield.com/news/poweliks-command-line-confusion/  

Per armare il file .chm bisogna inserire la backdoor in Javascript compilando il file di Help.  
Link a uno script di esempio della backdoor: https://gist.github.com/anonymous/15e99d0fd883692bd2e300634ed3c09b  

![image](https://user-images.githubusercontent.com/110602224/193608804-17652ee7-3c2a-45d6-9cee-0a923120af6c.png)

Link a un altro script preso da Nishang (Github): https://raw.githubusercontent.com/samratashok/nishang/master/Client/Out-CHM.ps1  
Link a uno script per la gestione della reverse shell.  
Per rendere lo script più efficiente e robusto si può modificare lo script JSRAT.py per diventare un punto di partenza per una connessione meterpreter / Powershell Empire:  
Link: https://gist.github.com/anonymous/ce4e2c4c83d900739395c695cc1ec55e
Link 2: https://github.com/Hood3dRob1n/JSRat-Py
![image](https://user-images.githubusercontent.com/110602224/193610676-6a3f9297-4e81-4dd6-b55f-37928f3e4075.png)

#### HTA - HTML Application
I file HTA sono delle vere e proprie applicazioni, fidate e lo cui sfruttamento può fare affidamento a Internet Explorer e browser.  

Programmi utili per armare i file HTA sono Metasploit, PowerShell Empire, SET, Unicorn e demiguise.  
Link a script con backdoor Javascript:https://gist.github.com/anonymous/ed8801afafae5b4755b00a11c63c244e  
![image](https://user-images.githubusercontent.com/110602224/193612716-939f45eb-0391-4700-99be-528c1a512950.png)

#### LNK - Link
Secondo quanto pubblicato dalla stessa Microsoft, l'estensione .lnk, [MS-SHLLINK] , identifica un tipo di file binario definito come "shell link" o "shortcut" e contiene informazioni che possono essere usate per accedere dati di altri oggetti (OLE).  
I file .lnk hanno una limitazione a 260 simboli/caratteri se non diversamente specificato nelle impostazioni di Windows.  
In alternativa al link (https://gist.github.com/anonymous/6fdb40bc8279671f7492f8d6625e9454) è possibile trovare uno script che aggira questo limite.  
Lo stesso script apre una connessione TCP reverse shell... da provare inserendo un file .lnk in un documento di testo Word.  

![image](https://user-images.githubusercontent.com/110602224/193833528-625f0186-668f-483f-a46f-157b739d7b12.png)

#### IQY - Web Query
I file .iqy sono associati ad Excel.  
Le query web mettono a disposizione degli utenti la possibilità inserire direttamente in una cartella di lavoro di Excel il contenuto di un sito web, interno o esterno.  

Una buona tecnica consiste nello sfruttare le query web per recuperare credenziali di Windows o hash NTLM come indicato ai link che seguono:
- Link 1: http://www.labofapenetrationtester.com/2015/08/abusing-web-query-iqy-files.html
- Link 2: https://github.com/ryhanson/phishery  

#### MSG
Il formato .msg rappresenta file di singoli messaggi di Microsoft Outlook ed Exchange.  
Link a esempi di sfruttamento di questi file:
- Link 1: https://doublepulsar.com/oleoutlook-bypass-almost-every-corporate-security-control-with-a-point-n-click-gui-37f4cbc107d0  
- Link 2: https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/down-the-rabbit-hole-extracting-maliciousness-from-msg-files-without-outlook/  

#### RTF - Rich Text Format
I file .rtf a differenza di quelli finora presi in considerazione, hanno un particolare comportamento predefinito quando includono oggetti OLE: li scaricano automaticamente nella cartella dei file temporanei.  
Al link che segue si trova un'analisi di questo comportamento predefinito: https://web.archive.org/web/20170227205919/https:/securingtomorrow.mcafee.com/mcafee-labs/dropping-files-temp-folder-raises-security-concerns/  

----

### Come sviluppare un'applicazione personalizzata "ClickOnce"
La tecnologia ClickOnce consente agli amministratori di creare un'applicazione basata su Windows in grado di auto aggiornarsi e che può essere installata con la minima interazione da parte dell'utente, attraverso Internet Explorer.  

Come comportamento predefinito, Microsoft, ha esteso ai singoli utenti la possiblità di elevare i permessi in uso all'applicazione a livello di amministratore.  
Questo è possibile quando l'applicazione arriva dal computer locale, dalla Intranet locale e dai siti affidabili di Internet Explorer (IE Trusted Sites).  
Le applicazioni ClickOnce sono eseguite come dfsvc.exe e invocata tramite dfshim.dll, essendo componenti Core di Windows bypassano il whitelisting delle applicazioni.  

Esempio di utilizzo.  
Come primo passaggio si crea un "beaconing" malware basato su Powershell:
- Link esempio (blog): https://khr0x40sh.wordpress.com/2014/08/22/powershell-ie-backdoor/
- Link script beacon.ps1: https://gist.github.com/anonymous/286688913bffa163f3c761cb123e3627
- Link script c2.php: https://gist.github.com/anonymous/e547d692d956396b6d37fdb74c7a6417

![image](https://user-images.githubusercontent.com/110602224/193843138-abc9d11e-7534-4d50-9d2c-bfcadace0c2d.png)

![image](https://user-images.githubusercontent.com/110602224/193843550-7f986140-42fe-4074-b012-c2aacadc454c.png)

Il secondo passaggio prevede la creazione di un'applicazione ClickOnce.  
- Link a una guida dettagliata su come creare un'app usando Visual Studio: https://www.slideshare.net/NetSPI/all-you-need-is-one-a-click-once-love-story-secure360-2015
- Link a un file .txt su come istruire l'app a eseguire il payload: https://gist.github.com/anonymous/41a0cc1f3f5434e12a018f2b2e71bd81

Di default, le applicazioni ClickOnce sono scaricate nella cartella dei file temporanei e da lì autoeseguite.

Al fine di ridurre le tracce lasciate sul disco della vittima, bisogna apportare alcune modifiche alle guide e script di poco sopra.
Strumenti: 
- SharpPick (progetto PowerPick): https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick
- PowerSploit: https://github.com/PowerShellMafia/PowerSploit
- Extra: https://sixdub.medium.com/

SharpPick integra alcune funzioni di Powershell in .NET rendendo possibile l'esecuzione di script in Powershell all'interno dell'eseguibile ClickOnce senza che siano avviati altri processi (raccomandate sono la codifica (encoding) e crittografazione (encryption) del codice dello script).  

Esempio:  
La console in C# dell'applicazione include RunPS da SharpPick che esegue Invoke-Shellcode con codifica base64.  
Si apre un processo nascosto di notepad nel quale si inietta lo stager di meterpreter.  
È importante inserire il riferimnto alla dll System.Management.Automation.dll in VIsual Studio.  
Link a ConsoleApplication2 (console C#): https://gist.github.com/anonymous/759516440b9beaaf3e5a9b9f91531251
Link a script Invoke-Shellcode.ps1: https://gist.github.com/anonymous/d120e314fa97f9d493e8dcf784014961


----
----
### Macro Excel 4.0
Link di riferimento al sito Microsoft:https://support.microsoft.com/en-us/office/working-with-excel-4-0-macros-ba8924d4-e157-4bb2-8d76-2c07ff02e0b8?ui=en-us&rs=en-us&ad=us

Le Macro Excel 4.0 (XLM) sono un'alternativa alle Macro scritte in VBA in quanto molte azioni che si possono eseguire con le seconde sono possibli anche con le prime. 
La principale differenza risiede nel fatto che il COM (Component Object Model) fu introdotto dopo le Macro Excel 4.0 e quindi da queste non accessibile.  

Nonostante questo sistema di Macro sia stato sviluppato oltre 20 anni fa, alcune loro implementazioni e usi sono difficilmente individuabili da parte di Antivirus (AMSI incluso).  
Per inserire questo tipo di Macro in una versione moderna di Excel è necessario cliccare _Foglio1->Inserisci->Macro MS Excel 4.0_
Per testarne il funzionamento:
![image](https://user-images.githubusercontent.com/110602224/194866076-269111c6-f492-45a2-94a2-58f450987977.png)

![image](https://user-images.githubusercontent.com/110602224/194866127-74ff60d4-e04f-4267-882d-0da734410a92.png)

La funzione _REGISTER_ delle Macro XLM permette di caricare funzioni di DLL esportate, compreso le DLL Win32 API.  
Il formato SYLK fu creato negli anni 80 e fu introdotto per lo scambio di dati tra fogli di calcolo e database. 
Anche se poco usato, l'estensione .slk è associata di default con Excel.  

I file SYLK non sono protetti dalla visualizzazione in modalità protetta, questo significa che questi file quando inviati tramite email o scaricati dal Web non sono flaggati come file potenzialmente dannosi, non sono inclusi nella lista di allegati bloccati in Outlook, nella lista di default di OWA delle estensioni pericolose o segnalati come tali in Chrome.  
I file SYLK supportano le Macro XLM.

Per creare un file SYLK con Macro:
![image](https://user-images.githubusercontent.com/110602224/194867398-a47176f2-5ce0-4b16-817b-7aafdf53940d.png)

![image](https://user-images.githubusercontent.com/110602224/194867593-a1788148-8506-4fe9-9fae-8eb90f1f8f19.png)

![image](https://user-images.githubusercontent.com/110602224/194867731-5dc4f330-0b32-4bdf-9e98-fd86ad9c2adc.png)
Link a Shellcode_to_sylk: https://github.com/outflanknl/Scripts/blob/master/shellcode_to_sylk.py
Link a SharpShooter: https://github.com/mdsecactivebreach/SharpShooter/blob/master/modules/excel4.py

### Spoof dei processi genitori e parametri della linea di comando
Molte soluzioni EDR (Endpoint Detection and Response) moderne analizzano i comportamenti dei processi più che identificare i malware in base a una firma statica come hash o domain names usati.  
Per questo un processo Powershell creato da Microsoft Word viene flaggato come dannoso quasi all'istante.  

Windows crea una struttura di dati ogni volta che viene eseguito un processo il cui nome è PEB (Process Environment Block).
In questa struttura di dati, PEB, che viene mappata all'interno della memoria virtuale del processo sono contenute informazioni come l'istruzione+parametri per l'avvio del processo stesso. A questa struttura fanno riferimento i software di protezione per individuare software dannoso.  
PEB è memorizzato nello spazio di memoria dedicato al processo rendendolo quindi vulnerabile a modifiche (se eseguite con i diritti corretti):
- creare il processo nello stato "sospeso"
- usare NtQueryInformationProcess (https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess) per trovare l'indirizzo del PEB
- usare WriteProcessMemory (https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory) per sovrascrivere la linea di comando nel PEB
- riprendere l'esecuzione del processo

Windows mantiene traccia solo del comando usato per creare il processo e non quello usato una volta ripresa l'esecuzione dallo stato di sospensione del processo.  
![image](https://user-images.githubusercontent.com/110602224/194879102-928dc410-70de-4f38-bac0-e345cdda2b34.png)

![image](https://user-images.githubusercontent.com/110602224/194879198-30791e74-4826-44ea-b321-b7d89f189094.png)

### File Database Eseguibili (ACCDE)
I file ACCDE stanno per Microsoft Access Execute Only Database e sono usati per proteggere i file ACCDB.  
Il codice VBA nei file ACCDE non è visibile o modificabile da parte dell'utente.  
Il primo passaggio per sfruttare questi file per l'esecuzione di payload è di creare un database vuoto.  
Navigare poi al tab "Crea" e selezionare "modulo".
![image](https://user-images.githubusercontent.com/110602224/194879876-b223053f-a83f-4165-b6ac-8ee63e1f5471.png)

Usare il modulo per inserire una Macro in VBA che avvia il payload e modificare il nome in qualcosa di meno sospetto.  
Per avviare la Macro è necessaria un'altra Macro.  
Per posizionarla, Crea->EseguiCodice e il nome della funzione con il launcher del payload.  
![image](https://user-images.githubusercontent.com/110602224/194880430-96292991-0569-4262-8feb-988a5acbbfde.png)

In "Home", "Tutti gli oggetti" modificare il nome della macro in autoexec per eseguirla all'apertura del documento.  
![image](https://user-images.githubusercontent.com/110602224/194880664-5655f698-1d75-4233-b503-a452a267a5ac.png)

Salvare il file come ACCDE.  
![image](https://user-images.githubusercontent.com/110602224/194884246-43b398d2-7c43-4f9c-ba01-7eed4f443c93.png)

### VBA Stomping (Calpestare il codice VBA)
Questa tecnica consiste nel distruggere il codice sorgente VBA in un documento di Office e lasciare solo il bytecode Pre-parsed (P-Code) pronto all'esecuzione.  
In uqesto modo sistemi di identificazione delle minacce basati su analisi statica del codice falliscono in quanto il codice originale può essere diverso o rimosso.  

Quando si apre il documento, il codice Pre-parsed è usato per eseguire la macro contenuto nel codice sorgente.  
Questa tecnica funziona solo se il P-Code è stato generato ed eseguito nella stesso stessa versione del progetto VBA.  
In caso contrario il codice sorgente sarà decompresso e ricompilato nel P-Code rendendo più difficile la riuscita.  

![image](https://user-images.githubusercontent.com/110602224/194885837-b84a35df-75d8-4a77-928d-6af2ec718c45.png)
Link EvilClippy:https://github.com/outflanknl/EvilClippy
Link Mono: https://www.mono-project.com/docs/about-mono/languages/csharp/

![image](https://user-images.githubusercontent.com/110602224/194885946-c5ce3e1b-076d-49e3-98c6-34dbb8dbca4f.png)

![image](https://user-images.githubusercontent.com/110602224/194886001-17b695d4-7cd3-4b69-93a4-cd2c1bb0cbde.png)

### Sfruttare Feature di Excel
Le PowerQuery di Excel (https://support.microsoft.com/it-it/office/informazioni-su-power-query-in-excel-7104fbee-9e62-4cb9-a02e-5bfb1a6c536a?redirectSourcePath=%252fen-us%252farticle%252fget-transform-in-excel-881c63c6-37c5-4ca2-b616-59e18d75b4de), Get & Transform, incluse in Excel possono connettere combinare e trasformare dati per analisi.  
La connessione a risorse esterne può essere sfruttata per estrarre hash NTLMv2 tramite Responder, SMBSERVER di IMPACKET o altri tool che pormettono la cattura delle hash.  
![image](https://user-images.githubusercontent.com/110602224/194892236-3cb27bdc-5ab3-4d6c-9830-d58225ac6a16.png)

![image](https://user-images.githubusercontent.com/110602224/194892296-2dbeea04-2b90-4869-8248-20eed82d6537.png)

![image](https://user-images.githubusercontent.com/110602224/194892329-a096b1bf-cd92-4d0c-a6be-4528c02e2082.png)

![image](https://user-images.githubusercontent.com/110602224/194892383-cc017fac-5dad-463b-8ed6-b3b999c50e36.png)

![image](https://user-images.githubusercontent.com/110602224/194892454-9c38e99a-139e-4241-aae8-5d397a5f8dae.png)

![image](https://user-images.githubusercontent.com/110602224/194892499-852f5ccd-2d4a-4518-801e-f23b66f5390c.png)

### Bypassare ambienti di sandbox e il whitelisting delle applicazioni
Lo script in Python "MaliciousMacroGenerator" (https://github.com/Mr-Un1k0d3r/MaliciousMacroGenerator/tree/master) è open source e automatizza la creazione di Macro che includono tecniche di evasione/bypass di antivirus e meccaniscmi di sandbox.  

![image](https://user-images.githubusercontent.com/110602224/194893450-24a95538-38b6-4ed9-87cb-2018d468287a.png)
![image](https://user-images.githubusercontent.com/110602224/194893520-14c98ebf-9470-4888-a83d-de516fbf3e3c.png)

![image](https://user-images.githubusercontent.com/110602224/194893675-708dd26a-7ca0-4f97-9a8f-5de34a300a54.png)
Link: https://github.com/giMini/PowerMemory/blob/master/RWMC/misc/reverseshell.xml

![image](https://user-images.githubusercontent.com/110602224/194893786-6a857b40-864a-4d8e-895c-30785e2c0351.png)

![image](https://user-images.githubusercontent.com/110602224/194893864-864fa976-b395-4bfa-b36e-0ae2fbd6c316.png)

![image](https://user-images.githubusercontent.com/110602224/194893941-7b591ec5-ba6c-4123-a40d-ef012b3ef0f0.png)














