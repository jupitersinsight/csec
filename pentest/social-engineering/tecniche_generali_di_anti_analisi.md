Lo scopo di quanto segue è quello di prendere coscienza di alcune tecniche di difesa utili affinché, durante una campagna di phishing, gli utenti finali compresi i membri dei "Blue Team" possa interferire o analizzare l'infrastruttura dell'hacker.  

## 1. Apache mod_rewrite si presta a tecniche anti-analisi
Prima opzione, utilizzare una istanza di apache come reindirizzatore posizionata tra le vittime e il server da cui sono lanciati gli attacchi.  
I reindirizzatori sono sacrificabili.
È normale che vengano individuati o spenti durante sessioni di attacco, soprattutto quelle prolungate, ed è quindi importante che i dati principali come i payload e le pagine di phishing siano mantenute su altri server più nascosti.  
In sostanza, un reindirizzatore (redirector) agisce come proxy e smista le richieste delle vittime verso le pagine di phishing "corrette": ad esempio le vittime che si collegano da smartphone saranno reindirizzat verso una pagina di phishing ottimizzata e creata per dispositivi mobili.  

Il modulo di Apache _mod\_rewrite_ consente di modificare al volo le URL: https://httpd.apache.org/docs/current/mod/mod_rewrite.html
Supportando un infinito numero di regole per riscrivere le URL, con questo modulo è possibile catturare l'User-Agent della richiesta e servire diverse pagine di phishing e payload.  

È possibile filtrare le richieste per attaccare specifici client, bloccare richieste, inoltrarle in buchi neri o fingere (per dare un maggiore senso di autenticità all'attacco) e inoltrare la pagina a una risorsa legittima come una pagina web del sito della vittima o del fornitore di un servizio.  
Sfruttando Macro, BeEF o HTML con JS (http://www.javascripter.net/faq/operatin.htm) è possibile estrarre il Sistema Operativo in uso nel dispositivo della vittima e modificare la richiesta web includendo un id.  
Dall'altra parte, sul server Apache, devono essere configurate delle regole per cui a ogni id è associato un sistema operativo a cui è associata una regola di modifica delle URL etc...  

![image](https://user-images.githubusercontent.com/110602224/194352846-ac3a68f4-c34c-4146-b9c1-d23f4a465f87.png)

Altro esempio di filtro si basa sul whitelisting o blacklisting degli indirizzi IP...permettendo gli IP delle vittime e bloccando quelli di eventuali investigatori.  

## 2. Malware basato su Macro con proprietà anti-analisi
![image](https://user-images.githubusercontent.com/110602224/194354066-dd3ceea2-6b84-49f2-a29b-491d8eb490f8.png)

![image](https://user-images.githubusercontent.com/110602224/194354321-174dce68-0f74-4250-ac07-c1000f855c54.png)

Lista di tecniche anti-analisi:
- https://cofense.com/macro-based-anti-analysis/
- https://github.com/joesecurity/pafishmacro
- https://www.mcafee.com/blogs/other-blogs/mcafee-labs/macro-malware-adds-tricks-uses-maxmind-to-avoid-detection/
- https://www.joesecurity.org/blog/4978232240698722172
- https://web.archive.org/web/20161023162702/https:/labs.bromium.com/2016/05/25/am-i-in-a-vm-the-tale-of-a-targeted-phish/

----

# Tecniche e precauzioni generali

## 1. Red Team Infrastructure
La progettazione dell'infrastruttura di un hacker, o Red Team, deve servire i seguenti scopi:
- deve avere comunicazioni sicure e affidabili (reliable and secure communications)
- non deve essere individuabile e deve nascondersi (obfuscation and detection avoidance)
- essere suddivisa in base alle funzionalità (segregate according to functionality)

![image](https://user-images.githubusercontent.com/110602224/194358763-a34e4b0f-a22e-4395-bbfd-889dd62b8607.png)

I nomi dei domini devono essere scelti in base allo scopo che si vuole raggiungere o alle operazioni che si devono svolgere.  
Nel caso di una campagna di phishing (o comunque legata ad attacchi di social-engineering) è utile scegliere nomi che avvalorino la causa.  
La categorizzazione dei domini aiuta in questo senso.  
Il tool Chameleon (https://github.com/mdsecactivebreach/Chameleon), verifica lo stato del proprio dominio e la sua categorizzazione nei principali servizi di profilazione dei siti web.  
Siccome categorizzare un dominio può richiedere tempo e soldi, spesso acquistare un dominio già categorizzato e usato risulta essere la via migliore (https://www.expireddomains.net/).  
La reputazione di questi domini scaduti si può verificare usando strumenti come VirusTotal (https://www.virustotal.com/gui/home/url) o BlueCoat (https://sitereview.bluecoat.com/#/) o automatizzato tramite DomainHunter (https://github.com/threatexpress/domainhunter).  

Importante è anche controllare lo storico degli indirizzi IP del dominio.  

Alcune categorie legate alla sanità, salute, privacy personale, servizi finanziari e altri non sono generalmente ispezionati dai sistemi di sicurezza. Queste categorie sono ideali per "nascondere" il proprio dominio.  
Con lo strumento online DNSChecker (https://dnschecker.org/) è possibile verificare la corretta propagazione dei DNS.  
Costruire l'infrastruttura necessaria per condurre una campagna di phishing può diventare un processo complicato.  
Il metodo più semplice consiste nell'utilizzare diversi VPS o servizi terzi fidati dal cliente per l'invio d email e per mantenere il framework di phishing nella zona interna dell'infrastruttura.  
Alcuni framework utili sono:
- GoPhish (https://getgophish.com/)
- Phishing Frenzy (https://www.phishingfrenzy.com/)
- King Phisher (https://github.com/rsmusllp/king-phisher)
- The Social Engineering Toolset (https://www.trustedsec.com/tools/the-social-engineer-toolkit-set/)

Nel caso si faccia uso di VPS che all'occorrenza possono essere spenti o rimossi, è importante rimuovere i prcedenti header del server e configurare indirizzi "catch-all" (https://help.one.com/hc/it/articles/360002165398-Cos-%C3%A8-un-indirizzo-catch-all) per ricevere le email "rimbalzate" o qualsiasi risposta utente.  

Un metodo semplice e veloce per configurare un server SMTP in un VPS consiste nell'utilizzare script come il seguente: https://github.com/adoreste/Postfix-Server-Setup  

Per nascondere i punti più sensibili dell'infrastruttura, è necessario fare uso di altri sistemi come i reindirizzatori che posti come punti più esterni si occupano di reindirizzare il traffico in ingresso.  

**Socat** è una utility basata su riga di comando che crea due stream di dati (byte streams) bidirezionali e trasferisce le informazioni tra esse. Può essere usato anche per reindirizzare connessioni TCP e UDP tra host sebbene una sessione deve rimanere aperta sul reindirizzatore.  
TMUX o SCREEN possono servire allo scopo e il traffico deve passare eventuali policy dei firewall.  
Esempio:  
![image](https://user-images.githubusercontent.com/110602224/194823377-8a23172c-847d-44d5-8072-0274fd2e707d.png)

**Iptables** può essere usato per inoltrare il traffico tra host, offre funzionalità di filtraggio e può reindirizzare traffico TCP e UDP.  
Può essere usato come reindirizzatore per query DNS, HTTP, TCP...  
Esempio di seguito, reindirizza traffico DNS associato a DNSCat2:
![image](https://user-images.githubusercontent.com/110602224/194823985-47a4c0c0-e3da-47df-ba5c-d295203b5fb3.png)

**OpenSSH** è un tool di connessione remota che opera con protocollo SSH.  
Tutto il traffico è criptato e offre una serie di funzionalità per il tunneling delle informazioni, diversi metodi di autenticazione e varie opzioni avanzate.  
Al fine di evitare problemi con connessioni ed evitare attacchi password l'autenticazione dovrebbe essere impostata solo su PKI.  
Fare anche uso di autossh (https://linux.die.net/man/1/autossh) per riavviare la connessione in caso di crash.  
Esempio di tunnel OpenSSH:  
![image](https://user-images.githubusercontent.com/110602224/194824897-c7da9be0-c724-408e-9be2-d434cd3923c8.png)

**Nginx** è un server HTTP ad alte prestazioni con supporto per reverse proxy.  
Di seguito esempio di configurazione per usare Nginx con reverse proxy con funzionalità simile a quanto descritto prima riferito ad Apache mod_rewrite.  
La vittima non si connetterà mai direttamente al server del red team aggiungendo in questo modo un eventuale ulteriore livello di segretezza all'infrastruttura.  
![image](https://user-images.githubusercontent.com/110602224/194825425-f34c1be3-321f-4c99-80b4-523a2b2b62b0.png)

![image](https://user-images.githubusercontent.com/110602224/194828213-0f46f3f3-8f12-41d8-a165-cd6a49d02e07.png)
Cat-Sites: https://github.com/coffeegist/cat-sites

![image](https://user-images.githubusercontent.com/110602224/194828464-ab5ee447-0f7d-4703-818a-7ac5ace17d64.png)
https://www.digitalocean.com/community/tools/nginx#?

![image](https://user-images.githubusercontent.com/110602224/194828744-a5b8b7c1-68d5-4f50-9a33-f93736f8d6c3.png)
http://nginx.org/en/docs/http/ngx_http_proxy_module.html

![image](https://user-images.githubusercontent.com/110602224/194829293-91163018-c6d4-4579-a7b1-15d637514671.png)

**Considerazioni finali**:
- usare iptables + ipset per limitare passaggio ai soli protocolli e paesi necessari
- rafforzare la configurazione SSH (https://infosec.mozilla.org/guidelines/openssh.html) e permettere connessioni solo da host fidati
- mantenere i sistemi aggiornati
- monitorare gli indirizzi IP e domini nelle backlist
- monitorare log e considera l'uso di RedELK (https://github.com/outflanknl/RedELK)
- considerare l'uso di Ansible per facilità di implementazione
- cambiare la _umask_ di default in favore di una più restrittiva e _chattr_ tutte le cartelle sensibili

----

Un reverse proxy è posizionato tra la vittima e il sito di destinazione (legittimo).  
Mentre mostra alla vittima il sito richiesto, cattura le credenziali e i token che possono essere usati per impersonare la sessione dell'utente.  

Muraena (https://conference.hitb.org/hitbsecconf2019ams/materials/D2T1%20-%20Muraena%20-%20The%20Unexpected%20Phish%20-%20Michele%20Orru%20&%20Giuseppe%20Trotta.pdf) e Necrobrowser sono due strumenti che,, usati insieme, offrono un sistema capace di creare un reverse proxy, catturare le credenziali e i token delle sessioni (<-- Muraena) ed estrarre dati e automatizzare azioni per conto della vittima (<-- Necrobrowser).  
I requisiti per utilizzare questi due strumenti sono:
- VPS/Server posizionati nella stessa regione dell'organizzazione target per mantenere coerenza idiomatica con messaggi proposti dal reverse proxy
- Nome di dominio

![image](https://user-images.githubusercontent.com/110602224/194834940-db640fa9-86e5-46a2-ab62-44d6ec001c5d.png)

![image](https://user-images.githubusercontent.com/110602224/194835022-9c53273f-bbe8-45d6-96ac-b26e852cbff4.png)

![image](https://user-images.githubusercontent.com/110602224/194835168-9dc550cb-96d8-4322-9fbc-8b157c06f581.png)

![image](https://user-images.githubusercontent.com/110602224/194835236-c178b4f6-5dc5-40b0-a9d5-6ea8b7c18b01.png)

![image](https://user-images.githubusercontent.com/110602224/194835292-333ef327-18c1-4b0d-972a-f2419a42d253.png)

![image](https://user-images.githubusercontent.com/110602224/194835343-98e709a7-9acb-406f-93c8-50bbdb028b1f.png)

![image](https://user-images.githubusercontent.com/110602224/194835431-c5025a26-4522-4a0f-8428-bb56280ad12b.png)

![image](https://user-images.githubusercontent.com/110602224/194835464-950e7e0d-d879-45cd-8ae3-aeee83907357.png)

