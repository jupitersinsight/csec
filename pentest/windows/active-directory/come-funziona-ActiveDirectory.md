# Fondamentali

Active Directory è un servizio di Windows basato sulla struttura a cartelle e consente agli amministratori di centralizzare autenticazioni e autorizzazioni.  
Fondamentali sono l'implementazione di accesso role-based e least-privilege.  

L'accesso alle risorse di Active Directory è basato sui ticket di autenticazione Kerberos (https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/bb742516(v=technet.10)?redirectedfrom=MSDN) mentre ai dispositivi che non fanno uso di Windows, come i firewall, possono autenticarsi usando LDAP o RADIUS. 

### Autenticazione

Molte aziende fanno uso di Active Directory in congiunzione con il concetto di Single Sign-On (SSO) (http://web.archive.org/web/20140209001507/http:/msdn.microsoft.com/en-us/library/aa745042(v=bts.10).aspx) che permette l'accesso a più dispositivi uniti tra loro sfruttando le credenziali di Active Directory.  
L'autenticazione SSO risulta tanto forte quanto il punto più debole della "rete" in quanto la compromissione di uno solo dei nodi può dare all'hacker la possibilità di recuperare le credenziali.  

Ogni volta che serve una connessione, una query o una modifica su un direcory service entra in gioco LDAP (Lightweight Directory Access Protocol) (https://learn.microsoft.com/it-it/previous-versions/windows/desktop/ldap/lightweight-directory-access-protocol-ldap-api?redirectedfrom=MSDN).  

![image](https://user-images.githubusercontent.com/110602224/197867129-d0695b84-115b-4121-9114-d6c6a5a34eaf.png)

Tipi comuni di autenticazione in Active Directory sono:
- Interactive logon: accesso al computer locale
- Network logon: accecco alle risorse di rete

Security Service Providers (SSP) comuni su sistemi di Windows:
- NTLM (https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831571(v=ws.11)?redirectedfrom=MSDN)
- Kerberos (https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831553(v=ws.11)?redirectedfrom=MSDN)

![image](https://user-images.githubusercontent.com/110602224/197869139-0f005eb5-70a0-4182-b09b-1e4d5f70bb44.png)

![image](https://user-images.githubusercontent.com/110602224/197869217-84801f8f-299b-4c90-83af-80e70678fc59.png)

![image](https://user-images.githubusercontent.com/110602224/197870746-4f0e5f85-7cab-49ec-89a8-5909101e91c2.png)

![image](https://user-images.githubusercontent.com/110602224/197870823-53c76952-2ac9-4c5a-ab25-e743fc178881.png)  

- Replay Attacks: http://web.archive.org/web/20171015173410/http:/windowsitpro.com/active-directory/understanding-how-kerberos-authentication-protects-against-replay-attacks  
- Pass-the-ticket: https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf  
- Over-pass-the-hash (aka pass the key): https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf  
- Offline (User) Password Cracking (Kerberoasting): https://adsecurity.org/?p=2293  
- Forged Tickets: Golden (https://adsecurity.org/?p=2293) - Silver (https://adsecurity.org/?p=2011)  
- Diamond PAC (https://www.blackhat.com/docs/eu-15/materials/eu-15-Beery-Watching-The-Watchdog-Protecting-Kerberos-Authentication-With-Network-Monitoring-wp.pdf)  
- MS14-068: https://labs.withsecure.com/publications/digging-into-ms14-068-exploitation-and-defence  
- Skeleton Key: https://www.secureworks.com/research/skeleton-key-malware-analysis  

### Autorizzazioni

L'accesso degli utenti alle risorse avviene tramite token che identificano i permessi di accesso a una data risorsa (permessi gestiti da ACLs).  
Un security principal (account utente, account gruppo o computer) è identificato principalmente dal suo SID (security identifier).  
Il SID è univoco per ogni security principal.  

Un'ACL (Access Control List) è una lista di ACE (Access Control Entry) che determinano per ogni security principal i permessi su una data risorsa.  
Le ACL si dividono in DACL e SACL.  
Una discretionary access control list identifica i security principal che sono ammessi o bloccati per una data risorsa.  
Una system acccess control list permette agli amministratori di loggare tentativi di accesso a risorse protette (es. generazione di log in caso di azione compiuta con successo o no).  
![image](https://user-images.githubusercontent.com/110602224/197984802-b63e5f17-8a69-4ec8-a7e8-9852ba36d46a.png)

### DNS

La presenza di DNS è fondamentale per il funzionamento di Active Directory che presenta una propria versione integrata, in questo caso le informazioni DNS sono memorizzate proprio in Active Directory.  

![image](https://user-images.githubusercontent.com/110602224/197985605-e9c4b63a-fa27-470e-a306-520282d7755a.png)

### Componenti 

![image](https://user-images.githubusercontent.com/110602224/197985836-83c9d055-d44d-43a2-9800-721f578fb2b5.png)

#### Domain Controllers

![image](https://user-images.githubusercontent.com/110602224/197986050-609ef3e1-c78b-4d9b-8c53-29a101a2fb60.png)

Ogni Domain Controller mantiene una copia dello stato delle directory e gli aggiornamenti sono propagati a tutti i Data Store (AD DS) degli altri controller tranne per quelli RODCs (Read-Only Domain Controllers).  
Un dominio può contente diversi domain controller e ognuno partecipa nel processo di autenticazione e autorizzazione.  

I Read-Only Domain Controller sono Controller in sola lettura sia nei servizi, nei DNS, nel SYSVOL...  hanno i loro account KRBTGT il che significa che anche sotto il profilo di autenticazione è separato dal resto del dominio.  

#### Global Catalog Servers

![image](https://user-images.githubusercontent.com/110602224/197987761-a5c3b346-0b94-4ae6-8f97-2293d896a6a7.png)

Gli amministratori non possono inserire informazioni direttamente in questa partizione. Il Global Catalog costruisce e aggiorna il suo contenuto in base a valori di un "schema attribute" (isMemberOfPartialAttributeSet), decidendo quando replicare quell'attributo di un oggetto di AD DS nel Global Catalog.  

#### AD DS data store

![image](https://user-images.githubusercontent.com/110602224/197988709-5dcfe08c-8067-4521-91b1-6132ba306f3e.png)

Il file NTDS.dit è un database usato principalmente per:  
- memorizzare gli oggetti accessibli in Active Directory
- fornire references agli oggetti
- memorizzare i security descriptors

Il database AD DS è gestito solo da Domain Controller.  

#### AD DS Replication

![image](https://user-images.githubusercontent.com/110602224/197989395-ee8cae29-0143-4e64-a59a-db652ecf0cd0.png)

I controller di dominio nello stesso sito replicano i dati in 15 secondi (circa), completando l'aggiornamento nell'intero tree in 45 secondi (circa).  

#### Domains

![image](https://user-images.githubusercontent.com/110602224/197990113-e5aa816d-5b95-40f2-89db-d102e2643789.png)

#### Trees

![image](https://user-images.githubusercontent.com/110602224/197990448-c029458f-ff08-4cf9-95f1-b4a5fccfb0de.png)

#### Forests

![image](https://user-images.githubusercontent.com/110602224/198032591-4c65bf57-9419-4c23-941a-d62e09ed0387.png)

#### Organizational Units

![image](https://user-images.githubusercontent.com/110602224/198032779-483b114a-e94e-4731-9ec5-08f52236e278.png)

#### Trusts

![image](https://user-images.githubusercontent.com/110602224/198032839-eeceaa67-0cf1-4ef1-a6e5-a7ae30479320.png)

I Domini permettono accesso a risorse condivise dall'esterno dei propri confini basandosi sui Trust.  
A livello di Foreste, i trust permettono a un utente di accedere a risorse in un altro dominio così come di autenticarsi presso altri domini.  


Link ad Atcive Directory Architecture: https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/bb727030(v=technet.10)?redirectedfrom=MSDN   
Link 2 ad Active Directory Architecture: https://www.microsoftpressstore.com/articles/article.aspx?p=2217264  

