# Persistence in Active Directory

Le tecniche di persistence si divono in due categorie:
1) **Userland**: ottenibile senza bisogno di privilege escalation
2) **Elevated**: solitamente più difficili da individuare e con maggiore libertà di azione ma richiedono privilege escalation  

### Start-Up (1)
Utile in ambiente in cui si fa uso della VDI in quanto il profilo utente viene scaricato in locale solo al momento dell'accesso dell'utente (roaming user profile).  
Le modifiche sono salvate nella repository centrale di riferimento alla chiusura della sessione utente.  
![image](https://user-images.githubusercontent.com/110602224/201711613-b3611fc9-a8e2-4c38-adf0-4e234878b38e.png)


### Registry (1)(2)
Il percorso HKEY_CURRENT_USER contiene informazioni sulla configurazione di Windows e applicazioni relative all'utente corrente e può essere sfruttata come persistence tipo (1).  
Il percorso HKEY_LOCAL_MACHINE richiede invece privilegi elevati per accettare modifiche.  
Percorsi sfruttabili: https://attack.mitre.org/techniques/T1547/001/

![image](https://user-images.githubusercontent.com/110602224/201712525-5f340575-4ac0-415f-872b-2f34b04d8448.png)


### LNKs (1)
Percorsi/scorciatoie di Windows che si possono modificare per eseguire comandi prima che venga lanciata l'applicazione a cui fanno riferimento.  
Link:https://github.com/HarmJ0y/Misc-PowerShell/blob/master/BackdoorLNK.ps1
![image](https://user-images.githubusercontent.com/110602224/201713011-a7438924-151f-4d75-b844-1c6e97b46649.png)


### Scheduled Tasks (1)(2)
Comando schtasks.exe vale anche per creare e modificare task in sistemi remoti.  
![image](https://user-images.githubusercontent.com/110602224/201713368-a79b5b2f-adab-45bb-b8f1-6737ac973509.png)


### WMI Permanent Event Subscriptions (2)
Comando per registrare sottoscrizioni nel database WMI e payload che saranno eseguiti come SYSTEM.  

\_\_EventFilter: azione che avvia il payload
\_\_EventConsumer: dove è salvato il payload
\_\_FilterToConsumerBinding: lega l'\_\_EventFilter all'\_\_EventConsumer

Tool utili per creare le sottoscrizioni:  
- [mofcomp](https://learn.microsoft.com/en-us/windows/win32/wmisdk/mofcomp)
- [wmic](https://support.microsoft.com/en-us/topic/a-description-of-the-windows-management-instrumentation-wmi-command-line-utility-wmic-exe-f5c16751-3a83-49ee-030d-5092ce1a04bb)
- [powershell](https://web.archive.org/web/20220528052517/https://gist.github.com/mattifestation/e55843eef6c263608206)
- csharp

Esempio di creazione di un eventfilter che si aziona poco dopo l'avvio di sistema e un eventconsumer che lancia l'eseguibile con privilegi SYSTEM.  
![image](https://user-images.githubusercontent.com/110602224/201714984-d69b57d0-e69c-4a0d-a93b-e3990a6e845d.png)


### Intro to COM Hijacking
Il sistema COM permette ai componenti software di comunicare pubblicizzando oggetti e le loro interfacce in una repository globale gestita dal registro di Windows.  
Il Registro di Sistema è costituito da hives:
- HKCU è l'hive dell'utente corrente e contiene oggetti COM user-based
- HKLM è l'hive della macchina locale e contiene oggetti COM relativi alla macchina
- HKCR è una vista unificata dei due hive precedenti dove sono caricati gli oggetti COM userland

Un processo con privilegi standard (medium integrity process) è in grado di registrare oggetti COM specifici per l'utente.  
Sebbene questi oggetti siano visibili solo all'utente hanno precedenza sugli oggetti della macchina locale.  

#### Panthom COM Objects
[ProcMon](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon) di Sysinternals tra le varie operazioni enumera gli errori di tipo _RegOpenKey_ con un percorso contenente _InProcServer32_ in quanto caricano la DLL presente nella chiave predefinita.  
![image](https://user-images.githubusercontent.com/110602224/201717602-124bcce7-7cc2-48b0-b25a-e4222096fde6.png)

Aggiungendo una delle chiavi mancanti in HKCU\Software\Classes\CLSID e creando InprocServer32 con un valore che punta a una DLL personalizzata, explorer (in questo esempio) tenta di accede il CLSID e caricherà la dll al riavvio successivo.  

**TESTARE BENE LE OPERAZIONI COM PRIMA DI INSERIRLE IN "PRODUZIONE"**

#### Scheduled Tasks COM Object Hijacking
Alcuni task in Windows hanno come azione un set di azioni definito come "Custom Handler".  
Interrogando il sistema di task si ottiene il riferimento all'azione da compiere: **schtasks /query /XML TN "\Microsoft\Windows\CertificateServicesClient\UserTask"**.  
![image](https://user-images.githubusercontent.com/110602224/201718949-f09f0799-f68a-49bc-890b-d8ded0ddecb3.png)

Significa che quando viene eseguito il task raggiunge la chiave in HKCR:\CLSID\{...}\InProcServer32 e carica la DLL indicata nel valore.  
Creando la stessa chiave in HKCU che punta a una DLL differente permette di ottenere la persistence cercata (i trigger degli utenti hanno la precedenza su quelli della macchina o globali per la macchina).  

![image](https://user-images.githubusercontent.com/110602224/201875745-7aac65f3-128f-4a6b-b166-bf3f8a42f3c7.png)

Per verificare quali tasks sono eseguiti al logon e hanno un Handler COM associato si può usare lo script [Get-ScheduledTaskComHandler.ps1](https://github.com/enigma0x3/Misc-PowerShell-Stuff/blob/master/Get-ScheduledTaskComHandler.ps1).  
![image](https://user-images.githubusercontent.com/110602224/201876155-60f76aa4-7520-4510-a693-4bb89ad1df1e.png)


#### COM "TreatAs" Hijacking
Gli oggetti COM hanno associata la chiave [TreatAs](https://learn.microsoft.com/en-us/windows/win32/com/treatas).  
DCOM controlla il Registro di Sistema locale per la chiave e prende il CLSID specificato in essa e l'avvia.  
Questa funzionalità è sfruttabile per introdurre oggetti COM malevoli e aggiunge un riferimento in TreatAs che punti a essi.  
Link PoC: https://gist.github.com/totoroha/9ea8529d0fb10437cc1c1c5544f5f115


### MS Office Trusted Locations
L'opzione nei software di Microsoft Office [che riguarda i percorsi attendibili](https://support.microsoft.com/en-us/office/add-remove-or-change-a-trusted-location-in-microsoft-office-7ee1cdc2-483e-4cbb-bcb3-4e7c67147fb4?ui=en-us&rs=en-us&ad=us) si può sfruttare per forzare il client a scaricare o eseguire DLL o Macro hostate dall'hacker, questa tecnica ignora eventuali GPO o add-in registrati.  
Tecnica utile in ambiente con in uso VDI in quanto i profili roaming sono, in alcuni casi, copiati in più macchine.  

![image](https://user-images.githubusercontent.com/110602224/201877756-97924f48-ae5a-48d6-a65f-b571c85445ec.png)
![image](https://user-images.githubusercontent.com/110602224/201877892-df1313ad-e6a5-4612-955d-4bd9c7d6a96d.png)


#### VBA "Add-Ins" For Excel
Excel fa uso di percorsi di sistema e specifici per utenti con file di avvio automatico.  
Queste cartelle di startup possono essere modificate da utenti con privilegi standard e a differenza del punto precedente servono file VBA invece di WLL.  
![image](https://user-images.githubusercontent.com/110602224/201878486-c3e11d74-a771-4667-8cff-0f1c57c03b93.png)


Extra:
- https://github.com/mandiant/SharPersist
- https://posts.specterops.io/hiding-registry-keys-with-psreflect-b18ec5ac8353
- https://labs.withsecure.com/publications/add-in-opportunities-for-office-persistence
