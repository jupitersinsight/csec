# Pivoting in Active Directory

### Remote Desktop Tunneling Using Virtual Channels  
Scenario.  
![image](https://user-images.githubusercontent.com/110602224/201629653-6339f7da-2b88-41f3-8715-a2e85b03be85.png)

"One of these services is the Dynamic Virtual Channel that enables us to communicate over an open RDP connection without the need to open a new socket, connection or a port on a firewall. These channels can be used to hide data from active network devices, to bypass firewalls, to implement device drivers over networks or just to help penetration testers to transfer data. The possibilities are endless."

[Dynamic Virtual Channels](https://learn.microsoft.com/en-us/windows/win32/termserv/dynamic-virtual-channels-reference):  
- DVC Client APIs: si tratta di API implementate specificamente per le connessioni client
- DVC Server APIs: si tratta di API implementate specificamente per il componente server

Questa funzionalità introdotta con WIndows VIsta e Windows Server 2008 non richiede l'uso di un account con privilegi e funziona anche se c'è in uso un firewall che agisce come proxy nella rete interna.  
L'obiettivo principale di questa tecnica è di sfruttare il terminal server come proxy per raggiungere la rete interna usando i Dynamic Virtual Channel.  
Tool necessari:  
- [Secure Socket Funneling](https://github.com/securesocketfunneling/ssf): tool cross-platform con capacità di port forwarding, socks e remote shell  
- [Universal Dynamic Virtual Channel conncetor for Remote Desktop Services](https://github.com/earthquake/UniversalDVC#installation): composto da un client (plugin .dll) e un server (.exe), crea un canale tra client/plugin e server.  

Nella macchina locale (client) copiare la .dll nella cartella corretta, system32 o SysWoW64, e registrarla usando regsvr32.  
Creare una mappatura con lettera alla cartella con i tool necessari.  
![image](https://user-images.githubusercontent.com/110602224/201634386-de1b9c76-b272-4c25-a8be-5ef23aea460b.png)
![image](https://user-images.githubusercontent.com/110602224/201634484-6d49517e-9f94-4783-b28d-6f896b89bd73.png)

Nel terminal server creare mappatura con lettera della cartella condivisa tramite RDP.  
![image](https://user-images.githubusercontent.com/110602224/201634730-7d2484f6-a489-45f4-8641-c530243e6e63.png)
![image](https://user-images.githubusercontent.com/110602224/201634772-6d59ed41-79be-4b83-96d9-8ea6e283e460.png)

Navigare fino alla cartella con i tool e avviare un server locale su porta 8080 e creare un reindirizzamento usando il file .exe (server).  
![image](https://user-images.githubusercontent.com/110602224/201635469-b1d9323f-d3fc-4a63-97d5-211fb2cb565b.png)
![image](https://user-images.githubusercontent.com/110602224/201635497-a3ab8863-d469-4d38-922a-f2febe276355.png)

Nella macchina client bisogna ora stabilire una connessione usando SSF alla porta reindirizzata (stesso effetto dello switch -D per ssh).  
SSFD si connette all'istanza ssfd in esecuzione nellla macchina remota e apre una porta locale 9090 che si può usare come socks proxy per la rete internal.  
![image](https://user-images.githubusercontent.com/110602224/201636205-4a2701b8-4fee-4efe-aeb2-24dbafc60100.png)
![image](https://user-images.githubusercontent.com/110602224/201636345-733ce01b-f2c6-46e0-9aca-890e7b9ce2f6.png)

Una valida alternativa, seppure con requisiti identici (plugin .dll + erver .exe), fa uso del tool [SocksOverRDP](https://github.com/nccgroup/SocksOverRDP).  
Nella macchina client bisogna prima di tutto importare questa [chiave di registro](https://github.com/nccgroup/SocksOverRDP/blob/master/SocksOverRDP-Plugin.reg) che contiene la configurazione per il proxy.  
Poi bisogna registrare la .dll.  
![image](https://user-images.githubusercontent.com/110602224/201637941-4aad7a7c-e8fe-42ce-a4e8-d4cd0cfe0caa.png)

Una volta connessi al Terminal Server si avvia il file .exe. In caso di errore installare Visual C++ Redistributable 2015+.  
![image](https://user-images.githubusercontent.com/110602224/201638311-57112e74-0d6f-4527-ba03-ae6cf7ba463f.png)

Da qui in poi, usando proxychains è possibile eseguire comandi attarverso il proxy.  


### SMB Pipes
Sebbene non supportano molte connessioni parallete/multiple, le SMB Pipes possono rivelarsi utili per il forward di porte locali e remote.  
Quando usati i tool [Invoke-Piper](https://github.com/p3nt4/Invoke-Piper) e [Invoke-SocksProxy](https://github.com/p3nt4/Invoke-SocksProxy) sono usati insieme si può fare forward con le porte dinamiche.  
![image](https://user-images.githubusercontent.com/110602224/201639885-968c8482-8e24-49fe-927e-665e378f4636.png)


### Windows Firewall  
![image](https://user-images.githubusercontent.com/110602224/201640305-eaa01a25-2604-45a2-aa26-77b4ac480a08.png)


### SharpShocks
{Questo tool](https://github.com/nettitude/SharpSocks) è in grado di aprire una connessione tunnel su HTTP con reverse shell essendo proxy-aware.  
Creando una "infrastruttura" di tunnel si può mascherare o comunque ridurre il rumore prodotto dai framework C2.  
![image](https://user-images.githubusercontent.com/110602224/201645502-d9320482-870d-482e-883d-4e09b4b6f397.png)
![image](https://user-images.githubusercontent.com/110602224/201646757-63363ff2-d3aa-4f3e-9518-2fa44e1950a4.png)


### SSHuttle
Link: https://github.com/sshuttle/sshuttle  
![image](https://user-images.githubusercontent.com/110602224/201646865-da587bea-c967-4e26-ba24-9b126b7ba68c.png)


### RPivot
Link: https://github.com/klsecservices/rpivot  
![image](https://user-images.githubusercontent.com/110602224/201708681-78e59a63-3cf7-4234-a202-e612b7bfc930.png)


### reGeorg
Link: https://github.com/sensepost/reGeorg  
![image](https://user-images.githubusercontent.com/110602224/201708894-494c15bf-8069-4b26-b542-fcb5a7972097.png)


### MSSQLProxy
Questo [toolkit](https://github.com/blackarrowsec/mssqlproxy) sfrutta la connessione di Microsoft SQL tra client e server per passare dati e informazioni.  
Sono necessari Impacket e privilegi amministrativi nel server con SQL in esecuzione.  
I componenti di MSSQLProxy sono:  
- CLR Assembly: assembly.cs
- Core DLL: deve essere compilato da reciclador.sln
- Client: mssqlclient.py da Impacket con funzionalità aggiuntive

![image](https://user-images.githubusercontent.com/110602224/201709874-1a6c3732-3bb0-4d21-9c20-dd30e7e9602d.png)
