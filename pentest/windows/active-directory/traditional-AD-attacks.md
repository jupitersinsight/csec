# Traditional Attacks

### LDAP Relay

SMB Relay non funziona in ambito Active Directory in quanto il flag _SMB Signing_ è attivo di default nel Domain Controller.  
Sfruttando il protocollo LDAP è possibile creare una sorta di NTLM Relay contro il Domain Controller.  

Tool: **intercepter-ng** (http://sniff.su/)  

La sequenza di attacco funziona così:
- Individuare una workstation di un Domain Administrator
- Diventare un MiTM tra la workstation e il gateway
- Inserire nel traffico web un link nascosto che punti a un listener HTTP che richiede autenticazione NTLM
- Relay delle credenziali catturate al Domain Controller

![image](https://user-images.githubusercontent.com/110602224/198040115-9a4726a5-fda9-4f75-81f9-e7d8062b3fdf.png)
![image](https://user-images.githubusercontent.com/110602224/198040306-f52be5a4-b045-4832-8cdb-63c7b567a5a5.png)


### Exploiting Group Policies

I Criteri di Gruppo o Group Policies (https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc779838(v=ws.10)?redirectedfrom=MSDN) sono uno strumento utile all'amministratore per la gestione e implementazione di configurazioni a utenti e computer.  
Le impostazioni delle Group Policies sono contenute nei Group Policy Objects e sono collegate ai contenitori di Active Directory come Siti, Domaini o Organizational Units.  

Nell'oggetto GPO c'è un collegamento che punta a SYSVOL (https://social.technet.microsoft.com/wiki/contents/articles/24160.active-directory-back-to-basics-sysvol.aspx), cartella che contiene i file relativi alle Group Policies.  
Interessante è diventare MiTM tra un client e la cartella SYSVOL di modo da alterare la Group Policy scaricata e applicata dal client.  

Microsoft rilascio una patch, MS15-011, per arginare questo tipo di attacco ma la patch da sola non è sufficiente https://www.rapid7.com/blog/post/2015/03/12/are-you-really-protected-against-group-policy-bypass-and-remote-code-execution/).  
L'unico exploit funzionante è contenuto in intercepter-ng.  
Esempio.

![image](https://user-images.githubusercontent.com/110602224/198042506-526e787b-fd2e-449e-9606-e163bd892b03.png)

![image](https://user-images.githubusercontent.com/110602224/198042572-a452b268-8e41-4b9b-9c8d-4ad4cf12abeb.png)

Inoltre, durante la fase di Post-Exploitation è possibile alterare le Group Policies o i file di riferimento in SYSVOL per poi distribuirle ai client.  


### RDP MiTM

La compromissione delle connessioni RDP comporta la decriptazione del tunnel e la lettura in chiaro dei keystrokes e delle credenziali.  

Tool: Cain (http://web.archive.org/web/20190101122212/http:/www.oxid.it/cain.html)  
Link di approfondimento: http://web.archive.org/web/20190101122212/http:/www.oxid.it/cain.html  

Tool: Seth (https://github.com/SySS-Research/Seth)  
Seth è in grado di creare una situazione MiTM anche se RDP è configurato per usare TLS o CredSSP provocando un downgrade della sicurezza del tunnel.  

Anche se Network Management LAN (NLA) può impedire questo tipo di attacco e il traffico generato da un attacco di ARP Poisoning è facilmente individuato da sistemi di monitoraggio, in molti casi ci si imbatte in sessioni RDP non configurate correttamente (ad esempio che non fanno uso di certificati autorevoli).  

Nel caso in cui si è in possesso dei privilegi SYSTEM è possibile effettuare l'hijack di sessioni RDP senza password (http://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html).  


### Sniffing Authentication Traffic

Intercettazione di traffico di rete criptato e non per raccogliere informazioni su nomi di dominio, query DNS, usernames, hashes...

Tools di esempio: Cain, Intercept-ng, PCredz (https://github.com/lgandx/PCredz)  


### Downgrading NTLM

Se nella configurazione LAN Manager generale del dominio è configurato un livello di sicurezza diverso da _Send NTLMv2 response only\refuse LM & NTLM_ è possibile eseguire un attacco NTLM Downgrade.  
Anche se un client dovesse richiedere un livello di autenticazione più forte, sfruttando Cain si può forzare il downgrade della sessione.  
In questo modo si ottengono delle hash più facili da rompere.  
**Da notare che l'ARP Poisoning per diventare oggetto delle connessioni NTLM è facilmente individuabile dai sistemi di monitoraggio**.  


### Non-MS Systems Leaking Credentials

I sistemi diversi da Windows o non di Microsoft che supportano l'autenticazione contro sistemi Windows possono essere soggette a leak di credenziali.  
Proxy web, applicazioni interne, console di virtualizzazione e server database che utilizzano l'autenticazione di Windows potrebbero inviare informazioni e credenziali in chiaro, usando Basic Authentication o autenticazione di rete LM.  


### LLMNR & NBT-NS Poisoning

Sia LLMNR sia NBT-NS sono sistemi di risoluzione hostname e indirizzi IP.  
Nel caso in cui un sistema DNS non sia raggiungibile, il client Windows usa LLMNR e poi NETBIOS.  
LLMNR e NETBIOS usano messaggi multicast/brodcast.  
Anche se si tratta di un sistema legacy risulta essere ancora in uso in ambiente Windows.  

Tool: Responder (https://github.com/lgandx/Responder)  

##### Enhancing Responder for a stealthier approach

Responder è solitamente associato a software per attacchi SMB Relay che lasciano tracce sul disco.  
Tools: Responder, finger.py, snarf (https://github.com/purpleteam/snarf)  

Prima di tutto è necessario individuare una workstation che faccia uso di credenziali privilegiate e una risorsa destinazione che non supporta SMB Signing.  

![image](https://user-images.githubusercontent.com/110602224/198065712-caaa76e9-1935-43ec-8491-7bf3e23a49e5.png)
![image](https://user-images.githubusercontent.com/110602224/198065816-f8540e9d-4616-4aec-8b6e-e0d59853d29f.png)
![image](https://user-images.githubusercontent.com/110602224/198065886-91b61144-b03e-45cb-ac4b-fbbbc884c5ab.png)
![image](https://user-images.githubusercontent.com/110602224/198066030-14ffb9bb-0818-4d3b-980a-ab67ebeed142.png)
![image](https://user-images.githubusercontent.com/110602224/198066525-1f5948d6-0bbf-446c-a8c6-abb57eadc3ca.png)
![image](https://user-images.githubusercontent.com/110602224/198066707-c4b525ed-1ab8-4219-83d7-7189528ca973.png)
![image](https://user-images.githubusercontent.com/110602224/198066882-8149d23f-406a-4a1d-a8da-e0b6311351c1.png)
![image](https://user-images.githubusercontent.com/110602224/198067034-793f39b4-0727-4df9-9699-f4f5a2f5feeb.png)
![image](https://user-images.githubusercontent.com/110602224/198067122-6aae67f2-7c26-4700-b9c3-8418bc3d6f52.png)

![image](https://user-images.githubusercontent.com/110602224/198067463-49cf24a3-71fd-456e-b0e6-30d7f3ab474d.png)
![image](https://user-images.githubusercontent.com/110602224/198067688-6759fb88-55ae-4f1e-86c2-a06a677fd269.png)
![image](https://user-images.githubusercontent.com/110602224/198067845-d3ef747e-a200-47da-8472-8b643a79e248.png)

