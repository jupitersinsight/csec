# Red Teaming MS SQL Server Fundamentals

Anche se sembra un'applicazione come altre, MSSQL in realtà un set di servizi di Windows, con nomi univoci, che funzionano integrati nel sistema operativo e ogni servizio agisce nel contento di sicurezza del service account di riferimento.  
Sommariamente esistono i seguenti tipi di account di SQL Server:  
- Account Windows
- SQL Server Logins (all'interno di SQL Server)
- Utenti Database (all'interno di SQL Server)

Gli account Windows e SQL Server sono usati per accedere al Server SQL.  
Per accedere ai dati, un login di SQL Server deve essere mappato a un database utente (se l'utente non è sysadmin).  
Un database utente è creato separatamente per ogni utente all'interno del database.  
I principali ruoli sono:
- sysadmin
- public

Link extra: https://learn.microsoft.com/en-us/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-ver16

Il ruolo sysadmin è equiparabile al ruolo di amministratore di Windows.  
Il ruolo public è equiparabile al gruppo Everyone di Windows e serve solo per fornire accesso con privilegi limitati.  

## Locating & Accessing SQL Servers

Di seguito come identificare e comportarsi con MSSQL da un punto di vista di utente non autenticato, con privilegi limitati o estesi.  

#### The unauthenticated perspective
Il modo migliore è di scansionare la rete su TCP, UDP e Broadcast.  
In questo caso i tool sono infiniti, tra cui [NMAP](https://nmap.org/), [Nessus](https://www.tenable.com/products/nessus/nessus-professional), [SQLping3](https://www.sqlsecurity.com/downloads), [OSQL](https://learn.microsoft.com/en-us/sql/tools/osql-utility?view=sql-server-ver16), [SQLcmd](https://learn.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=sql-server-ver16), [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL) e mssql_ping di Metasploit.  

Identificazione con sqlcmd: **sqlcmd -L**  
![image](https://user-images.githubusercontent.com/110602224/201893278-c602aa0f-870f-4536-8413-fd19b213cb0d.png)

Identificazione con mssql_ping.
![image](https://user-images.githubusercontent.com/110602224/201893459-c1826ffd-feea-44c7-adf6-6d9809d6c12e.png)

Identificazione con PowerUpSQL.  
![image](https://user-images.githubusercontent.com/110602224/201893621-7d2b3941-5249-423e-b681-a1d3790c812c.png)

A seguito della compromissione di host è possibile che si trovino documenti con informazioni sensibili o indicazioni che aiutano a indirizzare i passaggi successivi nella direzione corretta.  
Nel caso di un database caricato in Azure è possibile perseguire azioni di enumerazione attraverso un DNS dictionary attack, solitamente contro URL nel formato x.databases.windows.net.  
Altre informazioni da cercare in Azure sono file di configurazione, stringhe di connessione e simili.  

#### The local user perspective
Avendo accesso alla macchina target come utente locale è semplice indivduare la presenza di MSSQL verificando quali servizi e applicazioni sono installati e in esecuzione.  
In alternativa lo script PowerUpSQL comprende funzioni per aiutare nel compito.  
![image](https://user-images.githubusercontent.com/110602224/201895128-4c4e2ad3-d3bb-4890-9dc5-10fe95af7f76.png)

### The domain user perspective
Quando si installa SQL in un ambiente con Active Directory questo viene integrato fin da subito ed è associato a un service account.  
SQL supporta anche l'autenticazione Kerberos.  
È quindi possibile individuare l'installazione di SQL Server attraverso una scansione degli SPN e i tool:
- [setspn.exe](https://social.technet.microsoft.com/wiki/contents/articles/717.service-principal-names-spn-setspn-syntax.aspx)
- [adfind.exe](http://www.joeware.net/freetools/tools/adfind/index.htm)
- [Get-SPN](https://github.com/nullbind/Powershellery/blob/master/Stable-ish/Get-SPN/Get-SPN.psm1)
- PowerUpSQL

Identificazione tramite PowerUpSQL.
![image](https://user-images.githubusercontent.com/110602224/201896263-7bbe50af-1c04-4013-a6be-923491e9d6fb.png)


