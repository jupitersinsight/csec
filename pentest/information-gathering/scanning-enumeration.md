### Scanning
---------

Per condurre una scansione della rete che porti a ottimi risultati è importante usare più di uno strumento, come NMAP, HPING3 e FPING.  
NMAP è ottimizzato nelle scansioni automatizzate mentre HPING3 concede un maggiore controllo sulla creazione dei pacchetti.

**PRO-TIP**
Utilizzare come porta sorgente la porta 53 può portare a risultati anche su host che non hanno altre porte aperte in quanto la porta per DNS difficilmente è bloccata.

#### NMAP TIPS:
- Condurre scansioni solo ICMP usando il parametro **-PE** (in questo modo NMAP evita di scansionare le porte 80 e 443 per individuare se l'host è attivo)
- Nelle reti locali NMAP si basa sulle scansioni ARP per accelerare il processo di _ping sweep_ e all'occorrenza si può disattivare con il parametro **--disable-arp-ping**
- I parametri **-PS** e **-PU** si usano per scansioni solo TCP o solo UDP senza ICMP
- **-sS** implica scansioni TCP 2-WAY o _half-open_:
- 1) SYN - SYN/ACK - RST: open
- 2) SYN - RST/ACK: close
- 3) SYN - varie risposte vuote (o ICMP unreachable): filtered
- **-sT** implica una scansione 3-WAY o _full_ ma in questo caso la connessione TCP, essendo completa, viene registrata nei log
- **-sU** avvia scansioni sul protocollo UDP, più lente rispetto alle scansioni SYN e TCP ma utili perché alcuni host e servizi rispondono solo a questo protocollo:
- 1) UDP source comm - UDP dest replies - ICMP Echo unreachable from dest: open
- 2) UDP source comm - ICMP Echo unreachable from dest: closed
- **-sI** è usato per le scansioni "zombie".  
Le scansioni zombie sfruttano l'indirizzo IP di un'altra macchina per inviare richieste alla vittima. 
Lo zombie ideale dev'essere una macchina che gestisce la frammentazione dei pacchetti in maniera incrementale, **nmap -O -v -n [INDIRIZZO IP]**.  
Il campo ID nell'header IP è usato per tenere traccia dei pacchetti frammentati e ricomporli. Se implementato in modo tale che il conteggio sia incrementale e non imprevedibile NMAP è in grado di sfruttarlo tenendo traccia di eventuali modifiche al contatore come indicatore dello stato delle porte scansionate sulla vittima.  
! Comando: **nmap -Pn -sI [INDIRIZZO IP ZOMBIE:PORTA] [INDIRIZZO IP VTTIMA] -p [PORTE] -v**
1) NMAP invia un SYN/ACK alla macchina zombie la quale risponde con un RST (non aspettandosi un segmento TCP di conferma di sincronizzazione, risponde chiudendo la connessione) con un FragID=X (X è pari a un valore a caso)
2) NMAP invia una richiesta alla vittima usando l'IP della macchina zombie
3) Lo zombie riceve la risposta alla connessione del punto 2: SYN/ACK se la porta era aperta, RST se chiusa
4) Lo zombie risponde alla vittima inviando un RST in caso abbia ricevuto un segmento SYN/ACK e con FragID=X+1. In caso di RST, lo zombie non risponde il FragID rimane invariato
5) NMAP invia un SYN/ACK allo zombie e compara il valore del FragID (ricevuto con il RST) con quello precedente. Se il valore è cresciuto, allora la porta era aperta, altrimenti chiusa.  
_**Scansione LIVELLO NINJA DELLE OMBRE**_

**-n** forza nmap a non risolvere i nomi DNS al fine di ridurre il tempo necessario al completamento e produrre meno rumore sulla rete.  
**-b** è usato per avviare una scansione **FTP BOUNCE**, sfruttando quindi un server FTP vulnerabile per scansionare altri dispositivi.  
**-sA** è usato per inviare pacchetti con flag ACK il cui scopo è l'individuazione di firewall:
- se NMAP non riceve risposta allora la porta è filtrata, quindi potrebbe esserci un firewall
- se NMAO riceve un RST allora la porta non è filtrata, quindi non dovrebbe essere un firewall  
**-f** forza NMAP a frammentare i pacchetti, utile per aggirare firewall e sistemi IDS  
**--data-length** aggiunge bytes a caso ai pacchetti, utile quando usato con **-PE** in quanto le richieste ICMP di NMAP potrebbero essere troppo piccole e quindi scartate

-D option allows to perfom decoying actions, meaning that nmap will fake port scans (using the provided IP Addresses) while conducting a real one.
    1) nmap -D x.x.x.x,y,z,ME,o,p,u [target_address] (ME stands for attacker IP Address)
    2) nmap -D RND:X ... (RND:X tells nmap to use X random addresses)
--source-port tells nmap to use the specified source port
--spoof-mac tells nmap to craft packets with specific mac-addresses:
        1) from vendors like apple, dell... (--spoof-mac apple)
        2) auto-generated (--spoof-mac 0)
        3) manual input (--spoof-mac xx:xx:xx:xx:xx:xx)
--randomize-hosts allows to read input from a file list and scan them randomly (stealthy when used in slow scans (-T X))



HPING:
- Craft ad-hoc packets to probe a victim machine and get a response
- Idle Scans are the same called with NMAP -sI switch. In HPING they are cexecuted by using:
	1) to find good zombies candiates, the command is: hping3 -S -r -p [port] [IP ADDRESS]
		-r it is the switch responsible for checking the Fragmentation ID
		When "id=+1" is returned as part of scan result, that means this zombie canditate might be a good one to spoof
	2) to find open ports on zombie machine to exploit, a scan command must be issued: hping3 -S --scan-known [IP ADDRESS]
	3) ad hoc packets are to be crafted using information from previous scans: hping3 -a [ZOMBIE IP ADDRESS] -S -p [TARGET PORT] [TARGET IP ADDRESS]
	4) the FragID must be kept under active scanning issuing the command at point 1. If "id=+x" reports incresing values, target port might be open
To use different scan techniques the switches are:
	--scan (or -8 make use of TCP) + -S (set SYN flag in TCP header)
	--udp make use of UDP
		-- baseport (to speficy a source port)
		-- keep (to keep source port value unmodified while scannign)
		-- destport (to specify a destination port) + "+x" (destport grows of "+1" for each reply received) while "++x" (destport grows of "++1"
			for each request sent) ("x" if destport value)
To specify source ethernet interface -I option is to be used, plus -V for a more verbose output
--rand-source tells hping to use random IP Address as decoy (many firewalls are able to detect fake IP Addresses)
-a x.x.x.x tells hping to use the specified IP Addresses as decoy (spoofed IP, since the IP is being spoofed, it will
    receive the reponses to the probes sent... smurf alert)
--baseport or -s tells hping to use the specified source port
--data X is used to add random data to packets. Useful with packet fragmentation and to "confuse" firewalls by adding
random data to ordinary packets (such as packets destined to FTP, HTTP [...] ports).
While nmap adds random data, hping adds "x" to reach the data size needed.
--rand-dest tells hping to scan hosts in the given range randomly (e.g. 192.168.1.x, from x hping derives the netmask value)
-i x allows to set the delay between probes

	

FPING:
- Very good and "pinging" and create a nice target-list to fed NMAP with.

P0f:
- Used for passive OS fingerprinting and is pre-installed on Kali Linux
- Simplest and quickest way to put in action is: -/p0f -i [NIC]


Enumeration
------------

NETBIOS over TCP/IP is considered a proper protocol and it is an implementation of NETBIOS (API) for TCP/IP networks.
NETBIOS is a fundamental protocol used in Windows for sharing information, files and printers.
It uses ports UDP 137 (name services), UDP 138 (datagram services) and TCP 139 (sessions services).

NetBIOS Session Service allows connections to happen in order to exchange data. Once a file sharing connection is created using this service of NetBIOS, the endpoint switch over SMB.
Since Windows 2000 SMB is no longer bound to NetBIOS and direct SMB over TCP/IP connections are possible (TCP 445). Before Windows 2000, SMB relied on NetBIOS and its sessione service.

The main tool to enumerate NetBIOS is nbtstat (on Windows) and nbtscan (on Linux).
Net and its options, such as view, allows to list shares and other important information.
On Linux smbclient is the tool to use.

Administrative default Windows share, such as IPC$ are vulnerable to some attacks like null sessions attacks. Making use of net use is possible to connect to the victim machine IPC$ using null username and password.
More on this, some tools like winfingerprint, dumpsec and winfo exploit this vulnerability to perform enumration and gather information.
Enum4linux, rpcclient are tools available for Linux.

nbtstat is a Windows built-in command useful for scan and enumeration.
- nbtstat -A [IP_ADDRESS] returns a tables of name. Each name is given a numeric value, the most important is number 20 which indicates the presence of a file sharing service
- net view [IP_ADDRESS] returns a list of available shares			
- net use is used to connect or disconnect network shares (net use \\COMPUTERNAME\SHARE) [attacker has to know the login credentials in order to have access to the connected share]
- null session using net use : net use \\COMPUTERNAME\SHARE "" /user:""
- winfigerprint is a GUI software able to perform a great variety of tasks including NETBIOS null sessions exploit
- sid is a CLI program able to convert SID strings into usernames:
        1) sid2user.exe \\COMPUTERNAME SID (replace "-" with " ")
        2) the trailing value identifies the user o group (500 = Administrator, 501 = Guest, 1000+ = user defined users).
                This technique allows a simple usernames enumeration
- dumpsec automates NETBIOS scanning and enumeration (it comes both as CLI program and GUI program)

- enum4linux is a CLI program for available for Linux for NETBIOS/SMB scanning and enumeration. It relies on other software such as smbclient, nat, rpcclient, polenum, ldapsearch (included in ldapscripts).
- polenum is a Python script able to determine Windows password policies
- smbclient is one of the most common tool for NETBIOS/SMB scan and enumeration:
        1) smbclient -L [IP_ADDRESS] returns all available shares at target machine
        2) once connected  the "get" command allows for files retrieval



SNMP is a network protocol whose purpose is to monitor devices from a centrally managed console.
It sits on ports UDP 161 and UDP 162, with the first used for general messages and the second for trap messages.
At the moment exists 3 versions of SNMP :
	SNMP v1 the weakest since sends communications are in cleartext
	SNMP v2, better than v1 but still weak due to some weaknesses inhereted from v1
	SNMP v3, better the v1 and v2 since it uses ecnryption but susceptible to brute forcing
SNMP communications is based on the use of "passwords" called community strings which come in two forms:
	Private, allows write permissions
	Public, allows read permissions

snmpwalk simply "walks" down the MIB tree collecting information along the way.
snmpset is used to change values to OIDs.
NMAP NSE + scripts against snmp.
