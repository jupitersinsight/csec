## CORS (Cross-Origin Resource Sharing)

CORS allows XMLHtppRequests outside the origin domain but with special headers.  
They even support sending and retrieval of cookies (going up to the remote server).

### What is the Access-Control-Allow-Origin response header?

The _Access-Control-Allow-Origin_ header is included in the response from one website to a request originating from another website, and identifies the permitted origin of the request. A web browser compares the Access-Control-Allow-Origin with the requesting website's origin and permits access to the response if they match.

### Implementing simple cross-origin resource sharing

The cross-origin resource sharing (CORS) specification prescribes header content exchanged between web servers and browsers that restricts origins for web resource requests outside of the origin domain. The CORS specification identifies a collection of protocol headers of which _Access-Control-Allow-Origin_ is the most significant. This header is returned by a server when a website requests a cross-domain resource, with an _Origin_ header added by the browser.

For example, suppose a website with origin normal-website.com causes the following cross-domain request:

```http
GET /data HTTP/1.1
Host: robust-website.com
Origin : https://normal-website.com
The server on robust-website.com returns the following response:
```
```http
HTTP/1.1 200 OK
...
Access-Control-Allow-Origin: https://normal-website.com
```

The browser will allow code running on normal-website.com to access the response because the origins match.


The specification of Access-Control-Allow-Origin allows for multiple origins, or the value null, or the wildcard *. However, no browser supports multiple origins and there are restrictions on the use of the wildcard *.  

(Insecure) steps to bypass those limitations: 
- some web servers simply take the origin from client request and reflected back to him the **Access-Control-Allow-Origin** with the origin as value  
- some web servers perform regex expressions on request origin (as subdomain.bank.com matches to regex .bank.com) but even evil.bank.com would result legit
- whitelist null origin value 

Whitelisting the null value results in any requests coming from the NULL origin giving attackers the chance to enumerate credentials.


### Handling cross-origin resource requests with credentials

The default behavior of cross-origin resource requests is for requests to be passed without credentials like cookies and the Authorization header.  

However, the cross-domain server can permit reading of the response when credentials are passed to it by setting the CORS Access-Control-Allow-Credentials header to true. Now if the requesting website uses JavaScript to declare that it is sending cookies with the request:

```http
GET /data HTTP/1.1
Host: robust-website.com
...
Origin: https://normal-website.com
Cookie: JSESSIONID=<value>
```

And the response to the request is:

```http
HTTP/1.1 200 OK
...
Access-Control-Allow-Origin: https://normal-website.com
Access-Control-Allow-Credentials: true
```

Then the browser will permit the requesting website to read the response, because the Access-Control-Allow-Credentials response header is set to true. Otherwise, the browser will not allow access to the response.

A cross-domain server response of the form:

```http
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
```

is not permitted as this would be dangerously insecure, exposing any authenticated content on the target site to everyone.






