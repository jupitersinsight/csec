## The HTTP Protocol

HyperText Transfer Protocol (HTTP) is the standard protocol to access the World Wide Web (WWW). 

It was originally developed for retrieving static text-based resources and since then it has been extended and leveraged in various ways to enable it to support today's modern applications. It uses a message-based model in which a client send a request to the server and the server returns a response. 
Even though HTTP makes use of TCP, it is essentially connectionless. Each exchange of request and response is and autonomous transaction and may use a different TCP connection.  

### HTTP Requests

All HTTP messages (requests and responses) consist of one or more headers each on a separate line, a mandatory blank line and an optional message body.  
```http
GET /auth/488/YourDetails.ashx?uid=129 HTTP/1.1
Accept: application/x-ms-application, image/jpeg, application/xaml+xml, image/gif, image/pjpeg, application/x-ms-xbap, application/x-shockwave-flash, */*
Referer: https://mdsec.net/auth/488/Home.ashx
Access-Language: en-GB
User-Agent: Mozilla/4.0 (compatible: MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2; .NET CLR 2.0.52727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET4.0C; InfoPath.3; .NET4.0E; FDM; .NET CLR 1.1.4322)
Accept-Encoding: gzip, deflate
Host: mdsec.net
Connection: Keep-Alive
Cookie: SessionId=5B70C71F3FD4968935CDB668E545476
```
The first line of every HTTP message consists of a verb (GET), the requested URL (with parameter to be passed to the web application if needed marked by the _?_ character... in this case the param is _uid=129_) ancd the HTTP version being used.

The _Referer_ header is used to indicate the URL from which the request originated. 

The _User-Agent_ header is used to provide information about the browser or any other piece of software used to generate the request. The Mozilla User-Agent is historically important because it was used in Netscape browsers. Due to its large usage, other browsers used the same USer-Agent to assert compatiblity with the protocol version.  
As of today it remains a "standard" because of its historical importance (but browsers, like Chrome, tend to use other User-Agent).  

The _Host_ header specifies the hostname that appeared in the full URL being accessed. This header becomes very important when multiple sites are hosted on the same server.  

The _Cookie_ header is used to submit additional parameters that the server has issued to the client.  

### HTTP Response

A tipical HTTP Response:

```http
HTTP/1.1 200 OK
Date: Tue, 19 Apr 2011 09:23:32 GMT
Server: Microsoft-IIS/6.0
X-Powered-By: ASP.NET
Set-Cookie: tracking=tI8rk7joMx44S2Uu85nSWc
X-AspNet-Version: 2.0.50727
Cache-Control: no-cache
Pragma: no-cache
Expires: Thu, 01 Jan 1970 00:00:00 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1069

[BODY]
```

The first line of each response consists in the HTTP version being used, a numeric status code indicating the result of the request, a textual value further indicating the result of the request (no use in todays browsers).  

The _Server_ header indicates the web server software being used, it may contain names of modules installed. This information may or may not be accurate.  

The _Set-Cookie_ header contains cookies passed from the server to the client. The client must store the value and use it for every subsequent request.  

The _Pragma_ header instructs the browser not to store the response in its cache. The _Expires_ header indicates that the response content expired in the past and the browser is not meant to store it. The use of these headers is commoly adopted where dynamic content is used, in this way browsers always obtain the fresh and latest versio of the content.  

The _Content-Type_ header indicates the body's content type (in the example, html) while the _Content-Length_ header indicates the length of the body.  

Between headers and body there is a blank line.  

### HTTP Methods

The two most common HTTP methods are GET and POST.  

The GET method is used to retrieve resources. It can be used to send parameters which will be added to the URL. When a webpage is bookmarked, parameters are saved in the bookmark and other users who use the query will get the same page.  
In case of external links, URL requested using the GET method populates the _Referer_ header along with any parameter. This is why the GET method should never be trusted to send sensitive information.  

The POST method is used to perform actions. Parameters can be sent along withe the URL or in the body of the message. Although the URL can still be bookmarked, parameters are excluded from the bookmark. Furthermore, since POST is meant to perform actions, calling the same request will cause browsers to warn users about before repeating the same action twice.  

Besides _GET_ and _POST_, other methods are:

- _HEAD_ functions the same way as GET but the body is omitted from the response. The server is meant to return only the headers which are the same returned for a GET request, meaning this way could be useful for checking whether a resource exists before making a GET request.  
- _TRACE_ is designed for diagnostic purpose because the server is supposed to return in the message body the request received. In this way it should be easy to detect sort of "MiTM" attacks.
- _OPTIONS_ asks the server for a list of allowed HTTP methods for a specific resource.
- _PUT_ attempts to upload aa resource to the server. If the method is allowed it can be used to upload arbitrary file like scripts that will be executed on the server.  

### URL

A uniform resource locator (URL) is a unique identifier for web resources, its format is:  ```protocol://hostname[:port]/[path/]file[?param=value]```.  

### REST

Representational state transfer (REST) is a style architecture in which requests and responses contain representations of the current state os system's resources. The core technologies used in the World Wide Web (HTTP and URLs included) conform to the REST architectural style.  

Although URLs containing parameters within query strings do conform to REST constraints, the term _REST-style URLs_ identifies URLs in which parameters do appear in the URL file path.  

URL containing a query string:
```
http://example.com/search?make=ford&model=pinto
```

REST-style URL:
```
http://example.com/search/ford/pinto
```

### HTTP Headers

HTTP supports a large number of headers, some of which are designed to work only within requests, others within responses, each with a specific task and meaning.  

**General headers**

- _Connection_ tells the other end of the communication whether it should close the TCP connection after the HTTP communication finished or should keep it open.  
- _Content-Encoding_ specifies what encoding is being used for the content contained within the body. Some applications use _gzip_ to compress responses to speed up transmissions.
- _Content-Length_ specifies the length of the message body in bytes (except for responses to HEAD requests when indicates the length of the corrisponding GET request).
- _Content-Type_ specifies the content type of the message body, like _text/html_ for HTML documents.
- _Transfer-Encoding_ specifies any encoding performed on the message body to facilitate its transfer over HTTP (used to specify chunked encoding when employed).

**Request Headers**

- _Accept_ tells the server what kind of content the client is willing to accept such as image types, office documents and so on.
- _Accept-Econding_ tells the server what kinds of content encoding the client is willing to accept.
- _Authorization_ submits credentials to the server for one of the built-in HTTP authentication types.
- _Cookie_ submits cookies to the server that the server previously issued.
- _Host_ specifies the hostname that appears in the full URL being requests.
- _If-Modified-Since_ specifies when the resource was last accessed by the browser. If it has not changed, the server instructs the browser to use its cached copy sending a response with status code 304.
- _If-None-Match_ specifies an _entity tag_, which is an identifier denoting the contents of the message body. The browser sends the entity tag, along with the request, that the server issued when requested the resource. The server can use the entity tag to determine whether the browser may use its cached copy of the resource.
- _Origin_ is used in cross-domain Ajax requests to determine the domain from which the request originated.  
- _Referer_ specifies the URL from which the current request originated.
- _User-Agent_ provides information about the browser or other client software being used to generate the request.

**Response Headers**

- _Access-Control-Allow-origin_ indicates whether the resource can be retrieved via cross-domain Ajax requests
- _Cached-Control_ passes caching directives to the browser (for example, _no-cahce_)
- _ETag_ specifies an entity tag. Client browsers may submit this identifies in the _If-None-Match_ header to notify the server what version of the resource they have in cache and if they can use it
- _Expires_ tells the browser for how long the content of the message body are valid. The browser may use the cached copy of the resource until this time
- _Location_ is used in redirection responses (starting with 3xx) to indicate the location of the redirect
- _Pragma_ passes caching directives to the browser (like _no-cache_)
- _Server_ provides information about the web server software being used
- _Set-Cookie_ issues cookies to the browser which must be used in subsequent requests
- _WWW-Authenticate_ is used in responses that have a 401 status code to provide details on the type(s) of authentication the server supports
- _X-Frame-Options_ indicates whether and how the response may be loaded within a browser frame

### Status Codes

Each HTTP response message contains in its first line a status code indicating the result of the request. There are five groups of status codes:

- **1xx**: Informational
- **2xx**: The request was successful
- **3xx**: The client is redirected to a different resource
- **4xx**: The request contains an error of some kind
- **5xx**: The server encountered an error fulfilling the request

The most common status codes are:

- _100 Continue_ is sent when a client is sending a request to a server, the headers are received by the server which inform the client to send the message body
- _200 OK_ indicates that the request was successful and that the body of the response contains the result of the request
- _201 Created_ is returned to **PUT** requests to indicate that the request was successful
- _301 Moved Permanently_ redirects the browser permanently to a different URL, which is specified in the _Location_ header. The client should use the new URL in the future rather than the original
- _302 Found_ redirects the browser to a different URL specified in the _Location_ header. The client should use the original URL in subsequent requests
- _304 Not Modified_ instructs the browser to use its cached copy of the requested resource. The servers uses the _If-Modified-Since_ and _If-None-Match_ headers to determine whether the client browser has the latest version of the requested resource
- _400 Bad Request_ indicates that the client submitted an invalid request
- _401 Unauthorized_ indicates that the server requires HTTP authorization before let the client access the resource. The _WWW-Authenticated_ header contains details on the type(s) of authentication supported
- _403 Forbidden_ indicates that no one is allowed to access the resource, regardless of authentication
- _404 Not Found_ indicates that the requested resource does not exist
- _405 Method Not Allowed_ indicates that the method used in the request is not supported by the server
- _413 Request Entity Too Large_ indicates that the length of the message body is too large, for example while testing for buffer overflows vulnerability
- _414 Request URI Too Long_ similar to status code 413, indicates that the URL is too large
- _500 Internal Server Error_ indicates that the server encountered an error while processing the request
- _503 Service Unavailable_ indicates that, although the web server itself is functioning properly, the web application is not responding for some reason

### HTTP Proxy

The HTTP protocol, when proxies are in use, can work in two ways:

- when a browser issues an unencrypted HTTP request to a proxy server it places the full URL into the request, including the procotol prefix _http://_, the server's hostname and the port number (if is nonstandard). The proxy server extracts the hostname and port and uses these to direct the request to the correct destination web server
- when HTTPS is in use, the browser cannot perform the SSL handshake with the proxy server because this would break the secure tunnel and leave the communications vulnerable to interception attacks. Hence, the browser must use the proxy as pure TCP-level relay, which passes all network data in both directions between the browser and the web server with which the browser performs an SSL handshake as normal. To establish this relay, the browser makes an HTTP request to the proxy server using the _CONNECT_ method and specifying the destination hostname and port number as the URL. If the proxy allows the request it returns an HTTP response within a 200 status code, keeps the TCP connection open, and from that point onward acts as a pure TCP-level relay to the destination web server (like BurpSuite)

### HTTP Authentication

The HTTP protocol includes its own mechanisms for authenticating users:

- _Basic_ is a simple mechanism that sends credentials as a Base64-encoded string in a request with each message
- _NTLM_ is a challenge-response mechanism and uses a version of the Windows NTLM protocol
- _Digest_ is a challenge-response mechanism and uses MD5 checksums of a nonce with the user's credentials